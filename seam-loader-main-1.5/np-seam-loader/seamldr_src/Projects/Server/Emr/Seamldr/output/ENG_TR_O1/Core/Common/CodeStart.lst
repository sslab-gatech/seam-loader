     0                                   ;;; %define __?FILE?__ 
     0                                   ;;; %define __?LINE?__ 
     0                                   ;;; %define __?BITS?__ 
     0                                   ;;; %define __?PTR?__ 
     0                                   ;;; %define __?PASS?__ 2
     0                              <1> %define __?SECT?__
     0                              <1>  ;;; %define __?SECT?__ 
     0                              <1> %defalias __SECT__ __?SECT?__
     0                              <1>  ;;; %defalias __SECT__ __?SECT?__
     0                              <1> %imacro section 1+.nolist
     0                              <1> %define __?SECT?__ [section %1]
     0                              <1> __?SECT?__
     0                              <1> %endmacro 
     0                              <1> %imacro segment 1+.nolist
     0                              <1> %define __?SECT?__ [segment %1]
     0                              <1> __?SECT?__
     0                              <1> %endmacro 
     0                              <1> %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 1
     0                              <1>  ;;; %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 1
     0                              <1> %imacro sectalign 1+.nolist
     0                              <1> %ifidni %1,off
     0                              <1> %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 0
     0                              <1> %elifidni %1,on
     0                              <1> %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 1
     0                              <1> %else 
     0                              <1> [sectalign %1]
     0                              <1> %endif 
     0                              <1> %endmacro 
     0                              <1> %defalias __SECTALIGN_ALIGN_UPDATES_SECTION__ __?SECTALIGN_ALIGN_UPDATES_SECTION?__
     0                              <1>  ;;; %defalias __SECTALIGN_ALIGN_UPDATES_SECTION__ __?SECTALIGN_ALIGN_UPDATES_SECTION?__
     0                              <1> %imacro absolute 1+.nolist
     0                              <1> %define __?SECT?__ [absolute %1]
     0                              <1> __?SECT?__
     0                              <1> %endmacro 
     0                              <1> %imacro struc 1-2.nolist 0
     0                              <1> %push 
     0                              <1> %define %$strucname %1
     0                              <1> [absolute %2]
     0                              <1> %$strucname:
     0                              <1> %endmacro 
     0                              <1> %imacro endstruc 0.nolist
     0                              <1> %{$strucname}_size equ ($-%$strucname)
     0                              <1> %pop 
     0                              <1> __?SECT?__
     0                              <1> %endmacro 
     0                              <1> %imacro istruc 1.nolist
     0                              <1> %push 
     0                              <1> %define %$strucname %1
     0                              <1> %$strucstart:
     0                              <1> %endmacro 
     0                              <1> %imacro at 1-2+.nolist
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1> %2
     0                              <1> %endmacro 
     0                              <1> %imacro iend 0.nolist
     0                              <1> times %{$strucname}_size-($-%$strucstart) db 0
     0                              <1> %pop 
     0                              <1> %endmacro 
     0                              <1> %imacro align 1-2+.nolist nop
     0                              <1> %if __?SECTALIGN_ALIGN_UPDATES_SECTION?__
     0                              <1> sectalign %1
     0                              <1> %endif 
     0                              <1> times (((%1) - (($-$$) % (%1))) % (%1)) %2
     0                              <1> %endmacro 
     0                              <1> %imacro alignb 1-2+.nolist
     0                              <1> %if __?SECTALIGN_ALIGN_UPDATES_SECTION?__
     0                              <1> sectalign %1
     0                              <1> %endif 
     0                              <1> %ifempty %2
     0                              <1> [warning push]
     0                              <1> [warning -zeroing]
     0                              <1> resb (((%1) - (($-$$) % (%1))) % (%1))
     0                              <1> [warning pop]
     0                              <1> %else 
     0                              <1> times (((%1) - (($-$$) % (%1))) % (%1)) %2
     0                              <1> %endif 
     0                              <1> %endmacro 
     0                              <1> %imacro bits 1+.nolist
     0                              <1> [bits %1]
     0                              <1> %endmacro 
     0                              <1> %imacro use16 0.nolist
     0                              <1> [bits 16]
     0                              <1> %endmacro 
     0                              <1> %imacro use32 0.nolist
     0                              <1> [bits 32]
     0                              <1> %endmacro 
     0                              <1> %imacro use64 0.nolist
     0                              <1> [bits 64]
     0                              <1> %endmacro 
     0                              <1> %imacro extern 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [extern %1]
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro static 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [static %1]
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro global 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [global %1]
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro required 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [required %1]
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro common 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [common %1]
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro cpu 1+.nolist
     0                              <1> [cpu %1]
     0                              <1> %endmacro 
     0                              <1> %define __?FLOAT_DAZ?__ nodaz
     0                              <1>  ;;; %define __?FLOAT_DAZ?__ nodaz
     0                              <1> %define __?FLOAT_ROUND?__ near
     0                              <1>  ;;; %define __?FLOAT_ROUND?__ near
     0                              <1> %define __?FLOAT?__ __?FLOAT_DAZ?__,__?FLOAT_ROUND?__
     0                              <1>  ;;; %define __?FLOAT?__ __?FLOAT_DAZ?__,__?FLOAT_ROUND?__
     0                              <1> %defalias __FLOAT_DAZ__ __?FLOAT_DAZ?__
     0                              <1>  ;;; %defalias __FLOAT_DAZ__ __?FLOAT_DAZ?__
     0                              <1> %defalias __FLOAT_ROUND__ __?FLOAT_ROUND?__
     0                              <1>  ;;; %defalias __FLOAT_ROUND__ __?FLOAT_ROUND?__
     0                              <1> %defalias __FLOAT__ __?FLOAT?__
     0                              <1>  ;;; %defalias __FLOAT__ __?FLOAT?__
     0                              <1> %imacro float 1-*.nolist
     0                              <1> %rep %0
     0                              <1> [float %1]
     0                              <1> %ifidni %1,daz
     0                              <1> %define __?FLOAT_DAZ?__ daz
     0                              <1> %elifidni %1,nodaz
     0                              <1> %define __?FLOAT_DAZ?__ nodaz
     0                              <1> %elifidni %1,near
     0                              <1> %define __?FLOAT_ROUND?__ near
     0                              <1> %elifidni %1,up
     0                              <1> %define __?FLOAT_ROUND?__ up
     0                              <1> %elifidni %1,down
     0                              <1> %define __?FLOAT_ROUND?__ down
     0                              <1> %elifidni %1,zero
     0                              <1> %define __?FLOAT_ROUND?__ zero
     0                              <1> %elifidni %1,default
     0                              <1> %define __?FLOAT_DAZ?__ nodaz
     0                              <1> %define __?FLOAT_ROUND?__ near
     0                              <1> %endif 
     0                              <1> %rotate 1
     0                              <1> %endrep 
     0                              <1> %endmacro 
     0                              <1> %imacro default 1+.nolist
     0                              <1> [default %1]
     0                              <1> %endmacro 
     0                              <1> %imacro userel 0.nolist
     0                              <1> [default rel]
     0                              <1> %endmacro 
     0                              <1> %imacro useabs 0.nolist
     0                              <1> [default abs]
     0                              <1> %endmacro 
     0                              <1> %imacro usebnd 0.nolist
     0                              <1> [default bnd]
     0                              <1> %endmacro 
     0                              <1> %imacro usenobnd 0.nolist
     0                              <1> [default nobnd]
     0                              <1> %endmacro 
     0                              <1> %imacro incbin 1-2+.nolist 0
     0                              <1> %push 
     0                              <1> %pathsearch %$dep %1
     0                              <1> %depend %$dep
     0                              <1> %? %$dep,%2
     0                              <1> %pop 
     0                              <1> %endmacro 
     0                              <1> %defalias __NASM_MAJOR__ __?NASM_MAJOR?__
     0                              <1>  ;;; %defalias __NASM_MAJOR__ __?NASM_MAJOR?__
     0                              <1> %defalias __NASM_MINOR__ __?NASM_MINOR?__
     0                              <1>  ;;; %defalias __NASM_MINOR__ __?NASM_MINOR?__
     0                              <1> %defalias __NASM_SUBMINOR__ __?NASM_SUBMINOR?__
     0                              <1>  ;;; %defalias __NASM_SUBMINOR__ __?NASM_SUBMINOR?__
     0                              <1> %defalias __NASM_PATCHLEVEL__ __?NASM_PATCHLEVEL?__
     0                              <1>  ;;; %defalias __NASM_PATCHLEVEL__ __?NASM_PATCHLEVEL?__
     0                              <1> %defalias __NASM_SNAPSHOT__ __?NASM_SNAPSHOT?__
     0                              <1>  ;;; %defalias __NASM_SNAPSHOT__ __?NASM_SNAPSHOT?__
     0                              <1> %defalias __NASM_VERSION_ID__ __?NASM_VERSION_ID?__
     0                              <1>  ;;; %defalias __NASM_VERSION_ID__ __?NASM_VERSION_ID?__
     0                              <1> %defalias __NASM_VER__ __?NASM_VER?__
     0                              <1>  ;;; %defalias __NASM_VER__ __?NASM_VER?__
     0                              <1> %defalias __OUTPUT_FORMAT__ __?OUTPUT_FORMAT?__
     0                              <1>  ;;; %defalias __OUTPUT_FORMAT__ __?OUTPUT_FORMAT?__
     0                              <1> %defalias __DEBUG_FORMAT__ __?DEBUG_FORMAT?__
     0                              <1>  ;;; %defalias __DEBUG_FORMAT__ __?DEBUG_FORMAT?__
     0                              <1> %defalias __DATE__ __?DATE?__
     0                              <1>  ;;; %defalias __DATE__ __?DATE?__
     0                              <1> %defalias __DATE_NUM__ __?DATE_NUM?__
     0                              <1>  ;;; %defalias __DATE_NUM__ __?DATE_NUM?__
     0                              <1> %defalias __TIME__ __?TIME?__
     0                              <1>  ;;; %defalias __TIME__ __?TIME?__
     0                              <1> %defalias __TIME_NUM__ __?TIME_NUM?__
     0                              <1>  ;;; %defalias __TIME_NUM__ __?TIME_NUM?__
     0                              <1> %defalias __UTC_DATE__ __?UTC_DATE?__
     0                              <1>  ;;; %defalias __UTC_DATE__ __?UTC_DATE?__
     0                              <1> %defalias __UTC_DATE_NUM__ __?UTC_DATE_NUM?__
     0                              <1>  ;;; %defalias __UTC_DATE_NUM__ __?UTC_DATE_NUM?__
     0                              <1> %defalias __UTC_TIME__ __?UTC_TIME?__
     0                              <1>  ;;; %defalias __UTC_TIME__ __?UTC_TIME?__
     0                              <1> %defalias __UTC_TIME_NUM__ __?UTC_TIME_NUM?__
     0                              <1>  ;;; %defalias __UTC_TIME_NUM__ __?UTC_TIME_NUM?__
     0                              <1> %defalias __POSIX_TIME__ __?POSIX_TIME?__
     0                              <1>  ;;; %defalias __POSIX_TIME__ __?POSIX_TIME?__
     0                              <1> %defalias __FILE__ __?FILE?__
     0                              <1>  ;;; %defalias __FILE__ __?FILE?__
     0                              <1> %defalias __LINE__ __?LINE?__
     0                              <1>  ;;; %defalias __LINE__ __?LINE?__
     0                              <1> %defalias __BITS__ __?BITS?__
     0                              <1>  ;;; %defalias __BITS__ __?BITS?__
     0                              <1> %defalias __PTR__ __?PTR?__
     0                              <1>  ;;; %defalias __PTR__ __?PTR?__
     0                              <1> %defalias __PASS__ __?PASS?__
     0                              <1>  ;;; %defalias __PASS__ __?PASS?__
     0                              <1> %idefine __?infinity?__ %?
     0                              <1>  ;;; %idefine __?infinity?__ %?
     0                              <1> %idefine __?nan?__ %?
     0                              <1>  ;;; %idefine __?nan?__ %?
     0                              <1> %idefine __?qnan?__ %?
     0                              <1>  ;;; %idefine __?qnan?__ %?
     0                              <1> %idefine __?snan?__ %?
     0                              <1>  ;;; %idefine __?snan?__ %?
     0                              <1> %idefine __?float8?__ %?
     0                              <1>  ;;; %idefine __?float8?__ %?
     0                              <1> %idefine __?float16?__ %?
     0                              <1>  ;;; %idefine __?float16?__ %?
     0                              <1> %idefine __?float32?__ %?
     0                              <1>  ;;; %idefine __?float32?__ %?
     0                              <1> %idefine __?float64?__ %?
     0                              <1>  ;;; %idefine __?float64?__ %?
     0                              <1> %idefine __?float80m?__ %?
     0                              <1>  ;;; %idefine __?float80m?__ %?
     0                              <1> %idefine __?float80e?__ %?
     0                              <1>  ;;; %idefine __?float80e?__ %?
     0                              <1> %idefine __?float128l?__ %?
     0                              <1>  ;;; %idefine __?float128l?__ %?
     0                              <1> %idefine __?float128h?__ %?
     0                              <1>  ;;; %idefine __?float128h?__ %?
     0                              <1> %idefine __?utf16?__ %?
     0                              <1>  ;;; %idefine __?utf16?__ %?
     0                              <1> %idefine __?utf16le?__ %?
     0                              <1>  ;;; %idefine __?utf16le?__ %?
     0                              <1> %idefine __?utf16be?__ %?
     0                              <1>  ;;; %idefine __?utf16be?__ %?
     0                              <1> %idefine __?utf32?__ %?
     0                              <1>  ;;; %idefine __?utf32?__ %?
     0                              <1> %idefine __?utf32le?__ %?
     0                              <1>  ;;; %idefine __?utf32le?__ %?
     0                              <1> %idefine __?utf32be?__ %?
     0                              <1>  ;;; %idefine __?utf32be?__ %?
     0                              <1> %idefine __?ilog2e?__ %?
     0                              <1>  ;;; %idefine __?ilog2e?__ %?
     0                              <1> %idefine __?ilog2w?__ %?
     0                              <1>  ;;; %idefine __?ilog2w?__ %?
     0                              <1> %idefine __?ilog2f?__ %?
     0                              <1>  ;;; %idefine __?ilog2f?__ %?
     0                              <1> %idefine __?ilog2c?__ %?
     0                              <1>  ;;; %idefine __?ilog2c?__ %?
     0                              <1> %idefalias __infinity__ __?infinity?__
     0                              <1>  ;;; %idefalias __infinity__ __?infinity?__
     0                              <1> %idefalias __nan__ __?nan?__
     0                              <1>  ;;; %idefalias __nan__ __?nan?__
     0                              <1> %idefalias __qnan__ __?qnan?__
     0                              <1>  ;;; %idefalias __qnan__ __?qnan?__
     0                              <1> %idefalias __snan__ __?snan?__
     0                              <1>  ;;; %idefalias __snan__ __?snan?__
     0                              <1> %idefalias __float8__ __?float8?__
     0                              <1>  ;;; %idefalias __float8__ __?float8?__
     0                              <1> %idefalias __float16__ __?float16?__
     0                              <1>  ;;; %idefalias __float16__ __?float16?__
     0                              <1> %idefalias __float32__ __?float32?__
     0                              <1>  ;;; %idefalias __float32__ __?float32?__
     0                              <1> %idefalias __float64__ __?float64?__
     0                              <1>  ;;; %idefalias __float64__ __?float64?__
     0                              <1> %idefalias __float80m__ __?float80m?__
     0                              <1>  ;;; %idefalias __float80m__ __?float80m?__
     0                              <1> %idefalias __float80e__ __?float80e?__
     0                              <1>  ;;; %idefalias __float80e__ __?float80e?__
     0                              <1> %idefalias __float128l__ __?float128l?__
     0                              <1>  ;;; %idefalias __float128l__ __?float128l?__
     0                              <1> %idefalias __float128h__ __?float128h?__
     0                              <1>  ;;; %idefalias __float128h__ __?float128h?__
     0                              <1> %idefalias __utf16__ __?utf16?__
     0                              <1>  ;;; %idefalias __utf16__ __?utf16?__
     0                              <1> %idefalias __utf16le__ __?utf16le?__
     0                              <1>  ;;; %idefalias __utf16le__ __?utf16le?__
     0                              <1> %idefalias __utf16be__ __?utf16be?__
     0                              <1>  ;;; %idefalias __utf16be__ __?utf16be?__
     0                              <1> %idefalias __utf32__ __?utf32?__
     0                              <1>  ;;; %idefalias __utf32__ __?utf32?__
     0                              <1> %idefalias __utf32le__ __?utf32le?__
     0                              <1>  ;;; %idefalias __utf32le__ __?utf32le?__
     0                              <1> %idefalias __utf32be__ __?utf32be?__
     0                              <1>  ;;; %idefalias __utf32be__ __?utf32be?__
     0                              <1> %idefalias __ilog2e__ __?ilog2e?__
     0                              <1>  ;;; %idefalias __ilog2e__ __?ilog2e?__
     0                              <1> %idefalias __ilog2w__ __?ilog2w?__
     0                              <1>  ;;; %idefalias __ilog2w__ __?ilog2w?__
     0                              <1> %idefalias __ilog2f__ __?ilog2f?__
     0                              <1>  ;;; %idefalias __ilog2f__ __?ilog2f?__
     0                              <1> %idefalias __ilog2c__ __?ilog2c?__
     0                              <1>  ;;; %idefalias __ilog2c__ __?ilog2c?__
     0                              <1> %define __?NASM_MAJOR?__ 2
     0                              <1>  ;;; %define __?NASM_MAJOR?__ 2
     0                              <1> %define __?NASM_MINOR?__ 15
     0                              <1>  ;;; %define __?NASM_MINOR?__ 15
     0                              <1> %define __?NASM_SUBMINOR?__ 3
     0                              <1>  ;;; %define __?NASM_SUBMINOR?__ 3
     0                              <1> %define __?NASM_PATCHLEVEL?__ 0
     0                              <1>  ;;; %define __?NASM_PATCHLEVEL?__ 0
     0                              <1> %define __?NASM_VERSION_ID?__ 0020F0300h
     0                              <1>  ;;; %define __?NASM_VERSION_ID?__ 0020F0300h
     0                              <1> %define __?NASM_VER?__ "2.15.03"
     0                              <1>  ;;; %define __?NASM_VER?__ "2.15.03"
     0                              <1> %define __?SECT?__ [section .text]
     0                              <1>  ;;; %define __?SECT?__ [section .text]
     0                              <1> %macro __?NASM_CDecl?__ 1
     0                              <1> %endmacro 
     0                              <1> %imacro export 1+.nolist
     0                              <1> [export %1]
     0                              <1> %endmacro 
     0                              <1> %imacro safeseh 1.nolist
     0                              <1> [safeseh %1]
     0                              <1> %endmacro 
     0                              <1> %define __?DATE?__ "2024-08-22"
     0                              <1>  ;;; %define __?DATE?__ "2024-08-22"
     0                              <1> %define __?DATE_NUM?__ 20240822
     0                              <1>  ;;; %define __?DATE_NUM?__ 20240822
     0                              <1> %define __?TIME?__ "02:33:52"
     0                              <1>  ;;; %define __?TIME?__ "02:33:52"
     0                              <1> %define __?TIME_NUM?__ 023352
     0                              <1>  ;;; %define __?TIME_NUM?__ 023352
     0                              <1> %define __?UTC_DATE?__ "2024-08-22"
     0                              <1>  ;;; %define __?UTC_DATE?__ "2024-08-22"
     0                              <1> %define __?UTC_DATE_NUM?__ 20240822
     0                              <1>  ;;; %define __?UTC_DATE_NUM?__ 20240822
     0                              <1> %define __?UTC_TIME?__ "09:33:52"
     0                              <1>  ;;; %define __?UTC_TIME?__ "09:33:52"
     0                              <1> %define __?UTC_TIME_NUM?__ 093352
     0                              <1>  ;;; %define __?UTC_TIME_NUM?__ 093352
     0                              <1> %define __?POSIX_TIME?__ 1724319232
     0                              <1>  ;;; %define __?POSIX_TIME?__ 1724319232
     0                              <1> %define __?OUTPUT_FORMAT?__ win32
     0                              <1>  ;;; %define __?OUTPUT_FORMAT?__ win32
     0                              <1> %define __?DEBUG_FORMAT?__ cv8
     0                              <1>  ;;; %define __?DEBUG_FORMAT?__ cv8
     0                              <1> %define _ARCH_IA32 1
     0                              <1>  ;;; %define _ARCH_IA32 1
     0                              <1> %define _IPP_LE 1
     0                              <1>  ;;; %define _IPP_LE 1
     0                              <1> %define _TXT_ACM_ 1
     0                              <1>  ;;; %define _TXT_ACM_ 1
     0                              <1> %define MKF_ENGINEERING 1
     0                              <1>  ;;; %define MKF_ENGINEERING 1
     0                              <1> %define MKF_TRACE 1
     0                              <1>  ;;; %define MKF_TRACE 1
     0                              <1> %define MKF_USE_MAKEFLAG_H 1
     0                              <1>  ;;; %define MKF_USE_MAKEFLAG_H 1
     0                              <1> %define SIMICS_BLD 0
     0                              <1>  ;;; %define SIMICS_BLD 0
     0                              <1> %define TPR_SUPPORTED 0
     0                              <1>  ;;; %define TPR_SUPPORTED 0
     0                              <1> %define MKF_IBL_SUPPORTED 1
     0                              <1>  ;;; %define MKF_IBL_SUPPORTED 1
     0                              <1> %define TRACE_WITH_FUNCTIONS 0x74
     0                              <1>  ;;; %define TRACE_WITH_FUNCTIONS 0x74
     0                              <1> %define MCP_STACK_GAP (16 + 0)
     0                              <1>  ;;; %define MCP_STACK_GAP (16 + 0)
     0                              <1> %define __ASM__ 1
     0                              <1>  ;;; %define __ASM__ 1
     0                              <1> %define ACM_TYPE AC_BIOSAC
     0                              <1>  ;;; %define ACM_TYPE AC_BIOSAC
     0                              <1> %define MCP_SHADOW_STACK_GAP 0
     0                              <1>  ;;; %define MCP_SHADOW_STACK_GAP 0
     1                                  ;**********************************************************************;
     2                                  ;*                                                                    *;
     3                                  ;* Intel Proprietary                                                  *;
     4                                  ;*                                                                    *;
     5                                  ;* Copyright 2021 Intel Corporation All Rights Reserved.              *;
     6                                  ;*                                                                    *;
     7                                  ;* Your use of this software is governed by the TDX Source Code       *;
     8                                  ;* LIMITED USE LICENSE.                                               *;
     9                                  ;*                                                                    *;
    10                                  ;* The Materials are provided "as is," without any express or         *;
    11                                  ;* implied warranty of any kind including warranties of               *;
    12                                  ;* merchantability, non-infringement, title, or fitness for a         *;
    13                                  ;* particular purpose.                                                *;
    14                                  ;*                                                                    *;
    15                                  ;**********************************************************************;
    16                                  
    17                                  ;Same as 586
    18                                  CPU P4
    18                              <1>  ;;; [macro] CPU {P4}
     0                              <1> [cpu %1]
     0                              <1>  ;;; [cpu P4]
    19                                  ;---------------------------------------------------------------------------
    20                                  %include "AcmCom_NASM.inc"
    21                              <1> ;**********************************************************************;
    22                              <1> ;*                                                                    *;
    23                              <1> ;* Intel Proprietary                                                  *;
    24                              <1> ;*                                                                    *;
    25                              <1> ;* Copyright 2021 Intel Corporation All Rights Reserved.              *;
    26                              <1> ;*                                                                    *;
    27                              <1> ;* Your use of this software is governed by the TDX Source Code       *;
    28                              <1> ;* LIMITED USE LICENSE.                                               *;
    29                              <1> ;*                                                                    *;
    30                              <1> ;* The Materials are provided "as is," without any express or         *;
    31                              <1> ;* implied warranty of any kind including warranties of               *;
    32                              <1> ;* merchantability, non-infringement, title, or fitness for a         *;
    33                              <1> ;* particular purpose.                                                *;
    34                              <1> ;*                                                                    *;
    35                              <1> ;**********************************************************************;
    36                              <1> 
    37                              <1> %ifndef ACMCOM_EQU
    38                              <1> %define ACMCOM_EQU 0
    38                              <1>  ;;; %define ACMCOM_EQU 0
    39                              <1> 
    40                              <1> 
    41                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    42                              <1> ;                       MACROS
    43                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    44                              <1> 
    45                              <1> %define CR0_PG                             0x80000000
    45                              <1>  ;;; %define CR0_PG 0x80000000
    46                              <1> %define CR4_PAE                            0x20
    46                              <1>  ;;; %define CR4_PAE 0x20
    47                              <1> %define CR4_PSE                            0x10
    47                              <1>  ;;; %define CR4_PSE 0x10
    48                              <1> %define PAGE4K                             0x1000
    48                              <1>  ;;; %define PAGE4K 0x1000
    49                              <1> %define _1KB                               0x400
    49                              <1>  ;;; %define _1KB 0x400
    50                              <1> %define _2KB                               0x800
    50                              <1>  ;;; %define _2KB 0x800
    51                              <1> %define _4KB                               0x1000
    51                              <1>  ;;; %define _4KB 0x1000
    52                              <1> %define _4KB_MASK                          (  ~  ( _4KB - 1 ) )
    52                              <1>  ;;; %define _4KB_MASK ( ~ ( _4KB - 1 ) )
    53                              <1> %define IA32_EFER_MSR                      0xC0000080
    53                              <1>  ;;; %define IA32_EFER_MSR 0xC0000080
    54                              <1> %define LME                                0x100
    54                              <1>  ;;; %define LME 0x100
    55                              <1> %define YMM_REG_QWORDS                     4
    55                              <1>  ;;; %define YMM_REG_QWORDS 4
    56                              <1> %define LT_PUB_BASE                        0xFED30000
    56                              <1>  ;;; %define LT_PUB_BASE 0xFED30000
    57                              <1> %define _64KB                              0x10000
    57                              <1>  ;;; %define _64KB 0x10000
    58                              <1> %define LT_PRV_BASE                        0xFED20000
    58                              <1>  ;;; %define LT_PRV_BASE 0xFED20000
    59                              <1> %define BIT0                               0x1
    59                              <1>  ;;; %define BIT0 0x1
    60                              <1> %define BIT8                               0x100
    60                              <1>  ;;; %define BIT8 0x100
    61                              <1> %define BIT11                              0x800
    61                              <1>  ;;; %define BIT11 0x800
    62                              <1> %define CRASH_CODE_VALID                   0x80000000
    62                              <1>  ;;; %define CRASH_CODE_VALID 0x80000000
    63                              <1> %define MSR_CORE_THREAD_COUNT              0x35          ;Can be removed
    63                              <1>  ;;; %define MSR_CORE_THREAD_COUNT 0x35
    64                              <1> %define MSR_SMRR_PHYMASK                   0x1F3          ;Can be removed
    64                              <1>  ;;; %define MSR_SMRR_PHYMASK 0x1F3
    65                              <1> %define ACM_CODE64_SELECTOR                24
    65                              <1>  ;;; %define ACM_CODE64_SELECTOR 24
    66                              <1> %define CRASH_CODE_SW_GENERATED            0x40000000
    66                              <1>  ;;; %define CRASH_CODE_SW_GENERATED 0x40000000
    67                              <1> %define AC_BIOSAC                          0
    67                              <1>  ;;; %define AC_BIOSAC 0
    68                              <1> %define AC_SINIT                           1
    68                              <1>  ;;; %define AC_SINIT 1
    69                              <1> %define ERR_RLP_TIMEOUT                    1
    69                              <1>  ;;; %define ERR_RLP_TIMEOUT 1
    70                              <1> %define ERR_RLP_SMRR_CONFIG                3
    70                              <1>  ;;; %define ERR_RLP_SMRR_CONFIG 3
    71                              <1> %define ERR_RLP_SMRR2_CONFIG               4
    71                              <1>  ;;; %define ERR_RLP_SMRR2_CONFIG 4
    72                              <1> %define CLASS_ACM_EXIT                     7
    72                              <1>  ;;; %define CLASS_ACM_EXIT 7
    73                              <1> %define CLASS_INTERNAL_ERRORS              0x20
    73                              <1>  ;;; %define CLASS_INTERNAL_ERRORS 0x20
    74                              <1> %define ERR_SHADOW_STACK                   1
    74                              <1>  ;;; %define ERR_SHADOW_STACK 1
    75                              <1> %define MSR_IA32_BIOS_SIGN_ID              0x8B
    75                              <1>  ;;; %define MSR_IA32_BIOS_SIGN_ID 0x8B
    76                              <1> %define ERR_NO_RLP_UCODE_UPDATE            2
    76                              <1>  ;;; %define ERR_NO_RLP_UCODE_UPDATE 2
    77                              <1> %define MSR_SMRR_PHYMASK                   0x1F3
    77                              <1>  ;;; %define MSR_SMRR_PHYMASK 0x1F3
    78                              <1> %define MSR_SMRR2_PHYMASK                  0x1F7
    78                              <1>  ;;; %define MSR_SMRR2_PHYMASK 0x1F7
    79                              <1> %define MSR_SMRR2_PHYBASE                  0x1F6
    79                              <1>  ;;; %define MSR_SMRR2_PHYBASE 0x1F6
    80                              <1> %define MSR_IA32_MISC_ENABLES              0x1A0
    80                              <1>  ;;; %define MSR_IA32_MISC_ENABLES 0x1A0
    81                              <1> %define BIT18                              0x40000
    81                              <1>  ;;; %define BIT18 0x40000
    82                              <1> %define GDT_SIZE                           32
    82                              <1>  ;;; %define GDT_SIZE 32
    83                              <1> %define ACM_CODE_SELECTOR                  8
    83                              <1>  ;;; %define ACM_CODE_SELECTOR 8
    84                              <1> %define EXITAC                             3
    84                              <1>  ;;; %define EXITAC 3
    85                              <1> %define SENTER                             4
    85                              <1>  ;;; %define SENTER 4
    86                              <1> %define SEXIT                              5
    86                              <1>  ;;; %define SEXIT 5
    87                              <1> %define WAKEUP                             8
    87                              <1>  ;;; %define WAKEUP 8
    88                              <1> %define _8KB                               0x2000
    88                              <1>  ;;; %define _8KB 0x2000
    89                              <1> %define MSR_SMRR_PHYBASE                   0x1F2
    89                              <1>  ;;; %define MSR_SMRR_PHYBASE 0x1F2
    90                              <1> %define ACM_DATA_SELECTOR                  16
    90                              <1>  ;;; %define ACM_DATA_SELECTOR 16
    91                              <1> %define PORT80                             0x80
    91                              <1>  ;;; %define PORT80 0x80
    92                              <1> %define LBL_ACM                            0x1
    92                              <1>  ;;; %define LBL_ACM 0x1
    93                              <1> %define RFA_VALID                          0x8000
    93                              <1>  ;;; %define RFA_VALID 0x8000
    94                              <1> %define IDT32GATE_INIT_1                   0x8E00
    94                              <1>  ;;; %define IDT32GATE_INIT_1 0x8E00
    95                              <1> %define VACANT                             0x00
    95                              <1>  ;;; %define VACANT 0x00
    96                              <1> %define NOT_VACANT                         0x0ff
    96                              <1>  ;;; %define NOT_VACANT 0x0ff
    97                              <1> %define CR4_PGE                            (1 << 7)
    97                              <1>  ;;; %define CR4_PGE (1 << 7)
    98                              <1> %define ENTERACCS				           2
    98                              <1>  ;;; %define ENTERACCS 2
    99                              <1> %define MSR_BIOS_SE_SVN                    0x302
    99                              <1>  ;;; %define MSR_BIOS_SE_SVN 0x302
   100                              <1> %define MSR_BIOS_DONE    			       0x151
   100                              <1>  ;;; %define MSR_BIOS_DONE 0x151
   101                              <1> %define MSR_PLATFORM_INFO    			   0xCE
   101                              <1>  ;;; %define MSR_PLATFORM_INFO 0xCE
   102                              <1> %define MSR_PLATFORM_INFO_SAMPLE_PART	   (1 << 27)
   102                              <1>  ;;; %define MSR_PLATFORM_INFO_SAMPLE_PART (1 << 27)
   103                              <1> %define CR0_WP                             (1 << 16)
   103                              <1>  ;;; %define CR0_WP (1 << 16)
   104                              <1> %define CR4_PAE        					   (1 << 5)
   104                              <1>  ;;; %define CR4_PAE (1 << 5)
   105                              <1> %define CR4_PGE 					       (1 << 7)
   105                              <1>  ;;; %define CR4_PGE (1 << 7)
   106                              <1> %define CR4_LA57					       (1 << 12)
   106                              <1>  ;;; %define CR4_LA57 (1 << 12)
   107                              <1> %define CR4_SMXE                           (1 << 14)
   107                              <1>  ;;; %define CR4_SMXE (1 << 14)
   108                              <1> 
   109                              <1> %define MF_PRODUCTION      0
   109                              <1>  ;;; %define MF_PRODUCTION 0
   110                              <1> %define MF_DEBUG           (1 << 15)
   110                              <1>  ;;; %define MF_DEBUG (1 << 15)
   111                              <1> %define MF_PROD_WORTHY     0
   111                              <1>  ;;; %define MF_PROD_WORTHY 0
   112                              <1> %define MF_NOT_PROD_WORTHY (1 << 14)
   112                              <1>  ;;; %define MF_NOT_PROD_WORTHY (1 << 14)
   113                              <1> 
   114                              <1> 
   115                              <1> ; T_DATA no longer used after code changes
   116                              <1> 
   117                              <1> %define _GETSEC         db      0x0F, 0x37
   117                              <1>  ;;; %define _GETSEC db 0x0F, 0x37
   118                              <1> %define _MONITOR        db      0x0F, 0x01, 0x0C8
   118                              <1>  ;;; %define _MONITOR db 0x0F, 0x01, 0x0C8
   119                              <1> %define _MWAIT          db      0x0F, 0x01, 0x0C9
   119                              <1>  ;;; %define _MWAIT db 0x0F, 0x01, 0x0C9
   120                              <1> 
   121                              <1> ; append underscore to globals
   122                              <1> %pragma win32 gprefix _
   122                              <1>  ;;; [pragma win32 gprefix _]
   123                              <1> 
   124                              <1> %ifidn __OUTPUT_FORMAT__, win64
   125                              <1> DEFAULT REL      ; needed to instruct NASM to emit RIP-relative code
   126                              <1> %endif
   127                              <1> 
   128                              <1> %macro GETSEC_EXITAC 0
   129                              <1>         mov     eax, EXITAC                  ; GETSEC (EAX=3) for ExitAC
   130                              <1>         mov     ebx, %%RETURN_ADDRESS
   131                              <1>         xor     ecx, ecx
   132                              <1>         xor     edx, edx
   133                              <1>         _GETSEC
   134                              <1> %%RETURN_ADDRESS:
   135                              <1> %endmacro
   136                              <1> 
   137                              <1> %macro GETSEC_WAKEUP 0
   138                              <1>         mov     eax, WAKEUP                  ; GETSEC (EAX=8) for WAKEUP
   139                              <1>         xor     ebx, ebx
   140                              <1>         xor     ecx, ecx
   141                              <1>         xor     edx, edx
   142                              <1>         _GETSEC
   143                              <1> %endmacro
   144                              <1> 
   145                              <1> %macro GETSEC_SEXIT 0
   146                              <1>         mov     eax, SEXIT                  ; GETSEC (EAX=5) for SEXIT
   147                              <1>         xor     ebx, ebx
   148                              <1>         xor     ecx, ecx
   149                              <1>         xor     edx, edx
   150                              <1>         _GETSEC
   151                              <1> %endmacro
   152                              <1> 
   153                              <1> %macro TDATA_VAR  0
   154                              <1>         ;
   155                              <1>         ; Changing hardcoded T_DATA onto one retrieved from SINIT size
   156                              <1>         ;
   157                              <1>         mov     edi, LT_PUB_BASE + TXT.LT_SINIT_SIZE
   158                              <1>         mov     edi, DWORD [edi]    ; Get SINIT region size
   159                              <1>         add     edi, ebp
   160                              <1>         sub     edi, _64KB
   161                              <1> %endmacro
   162                              <1> %define TDATA_VAR_RET_VAL(x)  [edi + x] ; Sighting #3865476  End
   162                              <1>  ;;; %define TDATA_VAR_RET_VAL(x) [edi + x]
   163                              <1> 
   164                              <1> %macro TDATA_VAR_OFFSET_IN_EAX        1
   165                              <1>         ;
   166                              <1>         ; ebp keeps address of SINIT module in memory
   167                              <1>         ;
   168                              <1>         ; Changing hardcoded T_DATA onto one retrieved from SINIT size
   169                              <1>         ;
   170                              <1>         mov     edi, LT_PUB_BASE + TXT.LT_SINIT_SIZE
   171                              <1>         mov     eax, DWORD [edi]    ; Get SINIT region size
   172                              <1>         sub     eax, _64KB
   173                              <1>         add     eax, ebp
   174                              <1>         add     eax, %1
   175                              <1> 
   176                              <1> %endmacro
   177                              <1> 
   178                              <1> %define EDATA_VAR(x)    [ebp +  x]
   178                              <1>  ;;; %define EDATA_VAR(x) [ebp + x]
   179                              <1> 
   180                              <1> 
   181                              <1> %macro EDATA_VAR_OFFSET_IN_EAX        1
   182                              <1>         ;;
   183                              <1>         ;; ebp keeps address of SINIT module in memory
   184                              <1>         ;;
   185                              <1>         mov     eax, ebp
   186                              <1>         add     eax, %1
   187                              <1> %endmacro
   188                              <1> 
   189                              <1> %macro PROGRESS_MARK    1
   190                              <1>         push BYTE %1
   191                              <1>         call  ProgressMark
   192                              <1>         %if MKF_ENGINEERING eq 1
   193                              <1>                 %if MKF_TRACE EQ 1
   194                              <1>                         extern TraceProgress
   195                              <1>                         push DWORD %1
   196                              <1>                         call  TraceProgress
   197                              <1> 
   198                              <1>                 %endif
   199                              <1>         %endif
   200                              <1> %endmacro
   201                              <1> 
   202                              <1> %macro TRAMPOLINE_ERROR    1
   203                              <1>         %if MKF_ENGINEERING eq 1
   204                              <1>                 %if MKF_TRACE EQ 1
   205                              <1>                         extern TraceTrampolineCodeError
   206                              <1>                         push DWORD %1
   207                              <1>                         call TraceTrampolineCodeError
   208                              <1> 
   209                              <1>                 %endif
   210                              <1>         %endif
   211                              <1> %endmacro
   212                              <1> 
   213                              <1> %macro STACK_TEST_FILL_IN       0
   214                              <1> %if (MKF_ENGINEERING == 1)
   215                              <1>         mov     edi, stackStart
   216                              <1>         mov     ecx, esp
   217                              <1>         sub     ecx, stackStart
   218                              <1>         shr     ecx, 2
   219                              <1>         mov     eax, 0CCCCCCCCh
   220                              <1>         rep     stosd
   221                              <1> %endif
   222                              <1> %endmacro
   223                              <1> 
   224                              <1> 
   225                              <1> %define FILL64(H,L)     ( ( ( ( H ) - ( L ) ) / 8 ) - 1 )
   225                              <1>  ;;; %define FILL64(H,L) ( ( ( ( H ) - ( L ) ) / 8 ) - 1 )
   226                              <1> %define FILL8(H,L)      ( ( ( H ) - ( L ) ) - 1 )
   226                              <1>  ;;; %define FILL8(H,L) ( ( ( H ) - ( L ) ) - 1 )
   227                              <1> 
   228                              <1> ;%macro FILL64    2
   229                              <1> ;        exitm <( ( ( ( %1 ) - ( %2 ) ) / 8 ) - 1 ) >
   230                              <1> ;%endmacro
   231                              <1> ;
   232                              <1> ;%macro FILL8    2
   233                              <1> ;        exitm <( ( ( %1 ) - ( %2 ) ) - 1 ) >
   234                              <1> ;%endmacro
   235                              <1> 
   236                              <1> %define CR_Valid_cr                     1
   236                              <1>  ;;; %define CR_Valid_cr 1
   237                              <1> %define CR_SwGenerated_cr               1
   237                              <1>  ;;; %define CR_SwGenerated_cr 1
   238                              <1> %define CR_Res_cr                       5
   238                              <1>  ;;; %define CR_Res_cr 5
   239                              <1> %define CR_Minor_cr                     9
   239                              <1>  ;;; %define CR_Minor_cr 9
   240                              <1> %define CR_Source_cr                    1
   240                              <1>  ;;; %define CR_Source_cr 1
   241                              <1> %define CR_Major_cr                     5
   241                              <1>  ;;; %define CR_Major_cr 5
   242                              <1> %define CR_Class_cr                     6
   242                              <1>  ;;; %define CR_Class_cr 6
   243                              <1> %define CR_AcmType_cr                   4
   243                              <1>  ;;; %define CR_AcmType_cr 4
   244                              <1> 
   245                              <1> %define CR_Valid_cr_position                     31
   245                              <1>  ;;; %define CR_Valid_cr_position 31
   246                              <1> %define CR_SwGenerated_cr_position               30
   246                              <1>  ;;; %define CR_SwGenerated_cr_position 30
   247                              <1> %define CR_Res_cr_position                       25
   247                              <1>  ;;; %define CR_Res_cr_position 25
   248                              <1> %define CR_Minor_cr_position                     16
   248                              <1>  ;;; %define CR_Minor_cr_position 16
   249                              <1> %define CR_Source_cr_position                    15
   249                              <1>  ;;; %define CR_Source_cr_position 15
   250                              <1> %define CR_Major_cr_position                     10
   250                              <1>  ;;; %define CR_Major_cr_position 10
   251                              <1> %define CR_Class_cr_position                     4
   251                              <1>  ;;; %define CR_Class_cr_position 4
   252                              <1> %define CR_AcmType_cr_position                   0
   252                              <1>  ;;; %define CR_AcmType_cr_position 0
   253                              <1> 
   254                              <1> ;
   255                              <1> ; Crash register record
   256                              <1> ;
   257                              <1> ;CR      RECORD  Valid_cr:1,SwGenerated_cr:1,Res_cr:5,Minor_cr:9,Source_cr:1,Major_cr:5,Class_cr:6,AcmType_cr:4
   258                              <1> ;
   259                              <1> ; Policy control record
   260                              <1> ;
   261                              <1> ;PC      RECORD  Res2_pc:28,OWN_REQ_pc:1,CAP_EXT_pc:1,NPW_OK_pc:1,RES_pc:1
   262                              <1> 
   263                              <1> 
   264                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   265                              <1> ;                STRUCTURE DEFINITIONS
   266                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   267                              <1> 
   268                              <1> ;TXT STRUCTURE
   269                              <1> 
   270                              <1> struc TXT
   270                              <2>  ;;; [macro] struc {TXT},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::2] %$strucname TXT
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; TXT:
   271                              <1> .LT_STS:                          resq   1
   271 00000000 ????????????????    <1>  ;;; .LT_STS: resq 1
   272                              <1> ;// 0000h
   273                              <1> .LT_ESTS:                         resq   1
   273 00000008 ????????????????    <1>  ;;; .LT_ESTS: resq 1
   274                              <1> ;// 0008h
   275                              <1> .LT_THREADS_EXISTS:               resq   1
   275 00000010 ????????????????    <1>  ;;; .LT_THREADS_EXISTS: resq 1
   276                              <1> ;// 0010h
   277                              <1> .R1_0:                            resq   1
   277 00000018 ????????????????    <1>  ;;; .R1_0: resq 1
   278                              <1> ;// 0018h
   279                              <1> .LT_THREADS_JOIN:                 resq   1
   279 00000020 ????????????????    <1>  ;;; .LT_THREADS_JOIN: resq 1
   280                              <1> ;// 0020h
   281                              <1> .R1_1:                            resq   1
   281 00000028 ????????????????    <1>  ;;; .R1_1: resq 1
   282                              <1> ;// 0028h
   283                              <1> .LT_CRASH:                        resq   1
   283 00000030 ????????????????    <1>  ;;; .LT_CRASH: resq 1
   284                              <1> ;// 0030h
   285                              <1> .LT_CMD_SYS_RESET:                resq   1
   285 00000038 ????????????????    <1>  ;;; .LT_CMD_SYS_RESET: resq 1
   286                              <1> ;// 0038h
   287                              <1> .LT_CMD_OPEN_PRIVATE:             resq   1
   287 00000040 ????????????????    <1>  ;;; .LT_CMD_OPEN_PRIVATE: resq 1
   288                              <1> ;// 0040h
   289                              <1> .LT_CMD_CLOSE_PRIVATE:            resq   1
   289 00000048 ????????????????    <1>  ;;; .LT_CMD_CLOSE_PRIVATE: resq 1
   290                              <1> ;// 0048h
   291                              <1> .LT_CRASH2:                       resq   1
   291 00000050 ????????????????    <1>  ;;; .LT_CRASH2: resq 1
   292                              <1> ;// 0050h
   293                              <1> .R2_0:                            resq FILL64(0x0A0,0x50)
   293 00000058 <res 72>            <1>  ;;; .R2_0: resq ( ( ( ( 0x0A0 ) - ( 0x50 ) ) / 8 ) - 1 )
   294                              <1> .LT_SPAD:                         resq   1
   294 000000A0 ????????????????    <1>  ;;; .LT_SPAD: resq 1
   295                              <1> ;// 00A0h
   296                              <1> .R3_0:                            resq FILL64(0x100,0x0A0)
   296 000000A8 <res 88>            <1>  ;;; .R3_0: resq ( ( ( ( 0x100 ) - ( 0x0A0 ) ) / 8 ) - 1 )
   297                              <1> .LT_VER_FSBIF:                    resq   1
   297 00000100 ????????????????    <1>  ;;; .LT_VER_FSBIF: resq 1
   298                              <1> ;// 0100h
   299                              <1> .R3_1:                            resq   1
   299 00000108 ????????????????    <1>  ;;; .R3_1: resq 1
   300                              <1> ;// 0108h
   301                              <1> .LT_DIDVID:                       resq   1
   301 00000110 ????????????????    <1>  ;;; .LT_DIDVID: resq 1
   302                              <1> ;// 0110h
   303                              <1> .LT_EID:                          resq   1
   303 00000118 ????????????????    <1>  ;;; .LT_EID: resq 1
   304                              <1> ;// 0118h
   305                              <1> .R4_0:                            resq FILL64(0x200,0x118)
   305 00000120 <res 224>           <1>  ;;; .R4_0: resq ( ( ( ( 0x200 ) - ( 0x118 ) ) / 8 ) - 1 )
   306                              <1> .LT_VER_EMIF:                     resq   1
   306 00000200 ????????????????    <1>  ;;; .LT_VER_EMIF: resq 1
   307                              <1> ;// 0200h
   308                              <1> .R4_1:                            resq   1
   308 00000208 ????????????????    <1>  ;;; .R4_1: resq 1
   309                              <1> ;// 0208h
   310                              <1> .LT_CMD_LOCKMEM_CONFIG:           resq   1
   310 00000210 ????????????????    <1>  ;;; .LT_CMD_LOCKMEM_CONFIG: resq 1
   311                              <1> ;// 0210h
   312                              <1> .LT_CMD_UNLOCK_MEM_CONFIG:        resq   1
   312 00000218 ????????????????    <1>  ;;; .LT_CMD_UNLOCK_MEM_CONFIG: resq 1
   313                              <1> ;// 0218h
   314                              <1> .LT_CMD_UNLOCK_MEMORY:            resq   1
   314 00000220 ????????????????    <1>  ;;; .LT_CMD_UNLOCK_MEMORY: resq 1
   315                              <1> ;// 0220h
   316                              <1> .R4_2:                            resq   1
   316 00000228 ????????????????    <1>  ;;; .R4_2: resq 1
   317                              <1> ;// 0228h
   318                              <1> .LT_LOCK_BASE:                    resq   1
   318 00000230 ????????????????    <1>  ;;; .LT_LOCK_BASE: resq 1
   319                              <1> ;// 0230h
   320                              <1> .LT_UNLOCK_BASE:                  resq   1
   320 00000238 ????????????????    <1>  ;;; .LT_UNLOCK_BASE: resq 1
   321                              <1> ;// 0238h
   322                              <1> .R4_3:                            resq   1
   322 00000240 ????????????????    <1>  ;;; .R4_3: resq 1
   323                              <1> ;// 0240h
   324                              <1> .R4_4:                            resq   1
   324 00000248 ????????????????    <1>  ;;; .R4_4: resq 1
   325                              <1> ;// 0248h
   326                              <1> .LT_CMD_CACHE_INVALIDATE:         resq   1
   326 00000250 ????????????????    <1>  ;;; .LT_CMD_CACHE_INVALIDATE: resq 1
   327                              <1> ;// 0250h
   328                              <1> .LT_CMD_FLUSH_WB:                 resq   1
   328 00000258 ????????????????    <1>  ;;; .LT_CMD_FLUSH_WB: resq 1
   329                              <1> ;// 0258h
   330                              <1> .LT_NODMA_BASE:                   resq   1
   330 00000260 ????????????????    <1>  ;;; .LT_NODMA_BASE: resq 1
   331                              <1> ;// 0260h
   332                              <1> .LT_NODMA_SIZE:                   resq   1
   332 00000268 ????????????????    <1>  ;;; .LT_NODMA_SIZE: resq 1
   333                              <1> ;// 0268h
   334                              <1> .LT_SINIT_BASE:                   resq   1
   334 00000270 ????????????????    <1>  ;;; .LT_SINIT_BASE: resq 1
   335                              <1> ;// 0270h
   336                              <1> .LT_SINIT_SIZE:                   resq   1
   336 00000278 ????????????????    <1>  ;;; .LT_SINIT_SIZE: resq 1
   337                              <1> ;// 0278h
   338                              <1> .LT_CMD_LOCK_PMRC:                resq   1
   338 00000280 ????????????????    <1>  ;;; .LT_CMD_LOCK_PMRC: resq 1
   339                              <1> ;// 0280h
   340                              <1> .LT_CMD_UNLOCK_PMRC:              resq   1
   340 00000288 ????????????????    <1>  ;;; .LT_CMD_UNLOCK_PMRC: resq 1
   341                              <1> ;// 0288h
   342                              <1> .LT_MLE_JOIN:                     resq   1
   342 00000290 ????????????????    <1>  ;;; .LT_MLE_JOIN: resq 1
   343                              <1> ;// 0290h
   344                              <1> .R4_5:                            resq   1
   344 00000298 ????????????????    <1>  ;;; .R4_5: resq 1
   345                              <1> ;// 0298h
   346                              <1> .LT_BLOCKMAP_CAP:                 resq   1
   346 000002A0 ????????????????    <1>  ;;; .LT_BLOCKMAP_CAP: resq 1
   347                              <1> ;// 02A0h
   348                              <1> .LT_BLOCKMAP_CNF:                 resq   1
   348 000002A8 ????????????????    <1>  ;;; .LT_BLOCKMAP_CNF: resq 1
   349                              <1> ;// 02A8h
   350                              <1> .LT_BLOCKMAP_POINTER:             resq   1
   350 000002B0 ????????????????    <1>  ;;; .LT_BLOCKMAP_POINTER: resq 1
   351                              <1> ;// 02B0h
   352                              <1> .R4_6:                            resq   1
   352 000002B8 ????????????????    <1>  ;;; .R4_6: resq 1
   353                              <1> ;// 02B8h
   354                              <1> .LT_CMD_BLOCKMAP_EN:              resq   1
   354 000002C0 ????????????????    <1>  ;;; .LT_CMD_BLOCKMAP_EN: resq 1
   355                              <1> ;// 02C0h
   356                              <1> .LT_CMD_BLOCKMAP_DIS:             resq   1
   356 000002C8 ????????????????    <1>  ;;; .LT_CMD_BLOCKMAP_DIS: resq 1
   357                              <1> ;// 02C8h
   358                              <1> .LT_CMD_NODMA_CACHE_EN:           resq   1
   358 000002D0 ????????????????    <1>  ;;; .LT_CMD_NODMA_CACHE_EN: resq 1
   359                              <1> ;// 02D0h
   360                              <1> .LT_CMD_NODMA_CACHE_DIS:          resq   1
   360 000002D8 ????????????????    <1>  ;;; .LT_CMD_NODMA_CACHE_DIS: resq 1
   361                              <1> ;// 02D8h
   362                              <1> .LT_CMD_NODMA_TABLE_PROTECT_EN:   resq   1
   362 000002E0 ????????????????    <1>  ;;; .LT_CMD_NODMA_TABLE_PROTECT_EN: resq 1
   363                              <1> ;// 02E0h
   364                              <1> .LT_CMD_NODMA_TABLE_PROTECT_DIS:  resq   1
   364 000002E8 ????????????????    <1>  ;;; .LT_CMD_NODMA_TABLE_PROTECT_DIS: resq 1
   365                              <1> ;// 02E8h
   366                              <1> .LT_CMD_MEM_CONFIG_CHECKED:       resq   1
   366 000002F0 ????????????????    <1>  ;;; .LT_CMD_MEM_CONFIG_CHECKED: resq 1
   367                              <1> ;// 02F0h
   368                              <1> .R4_7:                            resq   1
   368 000002F8 ????????????????    <1>  ;;; .R4_7: resq 1
   369                              <1> ;// 02F8h
   370                              <1> .LT_HEAP_BASE:                    resq   1
   370 00000300 ????????????????    <1>  ;;; .LT_HEAP_BASE: resq 1
   371                              <1> ;// 0300h
   372                              <1> .LT_HEAP_SIZE:                    resq   1
   372 00000308 ????????????????    <1>  ;;; .LT_HEAP_SIZE: resq 1
   373                              <1> ;// 0308h
   374                              <1> .LT_MSEG_BASE:                    resq   1
   374 00000310 ????????????????    <1>  ;;; .LT_MSEG_BASE: resq 1
   375                              <1> ;// 0310h
   376                              <1> .LT_MSEG_SIZE:                    resq   1
   376 00000318 ????????????????    <1>  ;;; .LT_MSEG_SIZE: resq 1
   377                              <1> ;// 0318h
   378                              <1> .LT_SCRATCHPAD_0:                 resq   1
   378 00000320 ????????????????    <1>  ;;; .LT_SCRATCHPAD_0: resq 1
   379                              <1> ;// 0320h
   380                              <1> .LT_BIOSACMCode:                  resd   1
   380 00000328 ????????            <1>  ;;; .LT_BIOSACMCode: resd 1
   381                              <1> ;// 0328h
   382                              <1> .LT_ACM_BIOS_POLICY:              resd   1
   382 0000032C ????????            <1>  ;;; .LT_ACM_BIOS_POLICY: resd 1
   383                              <1> ;// 032ch
   384                              <1> .LT_DPR:                          resq   1
   384 00000330 ????????????????    <1>  ;;; .LT_DPR: resq 1
   385                              <1> ;// 0330h
   386                              <1> .R4_8:                            resq   1
   386 00000338 ????????????????    <1>  ;;; .R4_8: resq 1
   387                              <1> ;// 0338h
   388                              <1> .LT_FIT_STATUS:                   resq   1
   388 00000340 ????????????????    <1>  ;;; .LT_FIT_STATUS: resq 1
   389                              <1> ;// 0340h
   390                              <1> .R4_9:                            resq   1
   390 00000348 ????????????????    <1>  ;;; .R4_9: resq 1
   391                              <1> ;// 0348h
   392                              <1> .LT_INCREMENT:                    resq   1
   392 00000350 ????????????????    <1>  ;;; .LT_INCREMENT: resq 1
   393                              <1> ;// 0350h
   394                              <1> .LT_SPAD_3:                       resq   1
   394 00000358 ????????????????    <1>  ;;; .LT_SPAD_3: resq 1
   395                              <1> ;// 0358h
   396                              <1> .LT_SCRATCHPAD_4:                 resq   1
   396 00000360 ????????????????    <1>  ;;; .LT_SCRATCHPAD_4: resq 1
   397                              <1> ;// 0360h
   398                              <1> .LT_SCRATCHPAD_5:                 resq   1
   398 00000368 ????????????????    <1>  ;;; .LT_SCRATCHPAD_5: resq 1
   399                              <1> ;// 0368h
   400                              <1> .LT_INCREMENT_2:                  resq   1
   400 00000370 ????????????????    <1>  ;;; .LT_INCREMENT_2: resq 1
   401                              <1> ;// 0370h
   402                              <1> .LT_SCRATCHPAD_6:                 resq   1
   402 00000378 ????????????????    <1>  ;;; .LT_SCRATCHPAD_6: resq 1
   403                              <1> ;// 0378h
   404                              <1> .LT_CMD_OPEN_LOCALITY1:           resq   1
   404 00000380 ????????????????    <1>  ;;; .LT_CMD_OPEN_LOCALITY1: resq 1
   405                              <1> ;// 0380h
   406                              <1> .LT_CMD_CLOSE_LOCALITY1:          resq   1
   406 00000388 ????????????????    <1>  ;;; .LT_CMD_CLOSE_LOCALITY1: resq 1
   407                              <1> ;// 0388h
   408                              <1> .LT_CMD_OPEN_LOCALITY2:           resq   1
   408 00000390 ????????????????    <1>  ;;; .LT_CMD_OPEN_LOCALITY2: resq 1
   409                              <1> ;// 0390h
   410                              <1> .LT_CMD_CLOSE_LOCALITY2:          resq   1
   410 00000398 ????????????????    <1>  ;;; .LT_CMD_CLOSE_LOCALITY2: resq 1
   411                              <1> ;// 0398h
   412                              <1> .LT_CMD_OPEN_LOCALITY3:           resq   1
   412 000003A0 ????????????????    <1>  ;;; .LT_CMD_OPEN_LOCALITY3: resq 1
   413                              <1> ;// 03A0h
   414                              <1> .LT_CMD_CLOSE_LOCALITY3:          resq   1
   414 000003A8 ????????????????    <1>  ;;; .LT_CMD_CLOSE_LOCALITY3: resq 1
   415                              <1> ;// 03A8h
   416                              <1> .R5_0:                            resq FILL64(0x400,0x3A8)
   416 000003B0 <res 80>            <1>  ;;; .R5_0: resq ( ( ( ( 0x400 ) - ( 0x3A8 ) ) / 8 ) - 1 )
   417                              <1> .LT_PUBLIC_KEY:                   resq   1
   417 00000400 ????????????????    <1>  ;;; .LT_PUBLIC_KEY: resq 1
   418                              <1> ;// 0400h
   419                              <1> .R5_1:                            resq FILL64(0x608,0x400)
   419 00000408 <res 512>           <1>  ;;; .R5_1: resq ( ( ( ( 0x608 ) - ( 0x400 ) ) / 8 ) - 1 )
   420                              <1> .LT_ESTS_SET:                     resq   1
   420 00000608 ????????????????    <1>  ;;; .LT_ESTS_SET: resq 1
   421                              <1> ;// 0608h
   422                              <1> .LT_EXISTS_SET:                   resq   1
   422 00000610 ????????????????    <1>  ;;; .LT_EXISTS_SET: resq 1
   423                              <1> ;// 0610h
   424                              <1> .R5_2:                            resq   1
   424 00000618 ????????????????    <1>  ;;; .R5_2: resq 1
   425                              <1> ;// 0618h
   426                              <1> .LT_JOINS_SET:                    resq   1
   426 00000620 ????????????????    <1>  ;;; .LT_JOINS_SET: resq 1
   427                              <1> ;// 0620h
   428                              <1> .R6_0:                            resq FILL64(0x670,0x620)
   428 00000628 <res 72>            <1>  ;;; .R6_0: resq ( ( ( ( 0x670 ) - ( 0x620 ) ) / 8 ) - 1 )
   429                              <1> .LT_SCLEAN_SET:                   resq   1
   429 00000670 ????????????????    <1>  ;;; .LT_SCLEAN_SET: resq 1
   430                              <1> ;// 0670h
   431                              <1> .R7_0:                            resq FILL64(0x6A0,0x670)
   431 00000678 <res 40>            <1>  ;;; .R7_0: resq ( ( ( ( 0x6A0 ) - ( 0x670 ) ) / 8 ) - 1 )
   432                              <1> .LT_SPAD_SET:                     resq   1
   432 000006A0 ????????????????    <1>  ;;; .LT_SPAD_SET: resq 1
   433                              <1> ;// 06A0h
   434                              <1> .R8_0:                            resq FILL64(0x710,0x6A0)
   434 000006A8 <res 104>           <1>  ;;; .R8_0: resq ( ( ( ( 0x710 ) - ( 0x6A0 ) ) / 8 ) - 1 )
   435                              <1> .LT_EXISTS_CLEAR:                 resq   1
   435 00000710 ????????????????    <1>  ;;; .LT_EXISTS_CLEAR: resq 1
   436                              <1> ;// 0710h
   437                              <1> .R8_1:                            resq   1
   437 00000718 ????????????????    <1>  ;;; .R8_1: resq 1
   438                              <1> ;// 0718h
   439                              <1> .LT_JOINS_CLEAR:                  resq   1
   439 00000720 ????????????????    <1>  ;;; .LT_JOINS_CLEAR: resq 1
   440                              <1> ;// 0720h
   441                              <1> .R9_0:                            resq FILL64(0x770,0x720)
   441 00000728 <res 72>            <1>  ;;; .R9_0: resq ( ( ( ( 0x770 ) - ( 0x720 ) ) / 8 ) - 1 )
   442                              <1> .LT_SCLEAN_CLEAR:                 resq   1
   442 00000770 ????????????????    <1>  ;;; .LT_SCLEAN_CLEAR: resq 1
   443                              <1> ;// 0770h
   444                              <1> .R10_0:                           resq FILL64(0x7A0,0x770)
   444 00000778 <res 40>            <1>  ;;; .R10_0: resq ( ( ( ( 0x7A0 ) - ( 0x770 ) ) / 8 ) - 1 )
   445                              <1> .LT_SPAD_CLEAR:                   resq   1
   445 000007A0 ????????????????    <1>  ;;; .LT_SPAD_CLEAR: resq 1
   446                              <1> ;// 07A0h
   447                              <1> .R11_0:                           resq FILL64(0x800,0x7A0)
   447 000007A8 <res 88>            <1>  ;;; .R11_0: resq ( ( ( ( 0x800 ) - ( 0x7A0 ) ) / 8 ) - 1 )
   448                              <1> .LT_VER_FTIF:                     resq   1
   448 00000800 ????????????????    <1>  ;;; .LT_VER_FTIF: resq 1
   449                              <1> ;// 0800h
   450                              <1> .R11_1:                           resq   1
   450 00000808 ????????????????    <1>  ;;; .R11_1: resq 1
   451                              <1> ;// 0808h
   452                              <1> .LT_PCH_DIDVID:                   resq   1
   452 00000810 ????????????????    <1>  ;;; .LT_PCH_DIDVID: resq 1
   453                              <1> ;// 0810h
   454                              <1> .R12_0:                           resq FILL64(0x880,0x810)
   454 00000818 <res 104>           <1>  ;;; .R12_0: resq ( ( ( ( 0x880 ) - ( 0x810 ) ) / 8 ) - 1 )
   455                              <1> .LT_UCS:                          resq   1
   455 00000880 ????????????????    <1>  ;;; .LT_UCS: resq 1
   456                              <1> ;// 880h
   457                              <1> .R13_0:                           resq FILL64(0x8E0,0x880)
   457 00000888 <res 88>            <1>  ;;; .R13_0: resq ( ( ( ( 0x8E0 ) - ( 0x880 ) ) / 8 ) - 1 )
   458                              <1> .LT_CMD_SECRETS:                  resq   1
   458 000008E0 ????????????????    <1>  ;;; .LT_CMD_SECRETS: resq 1
   459                              <1> ;// 08E0h
   460                              <1> .LT_CMD_NO_SECRETS:               resq   1
   460 000008E8 ????????????????    <1>  ;;; .LT_CMD_NO_SECRETS: resq 1
   461                              <1> ;// 08E8h
   462                              <1> .LT_E2STS:                        resq   1
   462 000008F0 ????????????????    <1>  ;;; .LT_E2STS: resq 1
   463                              <1> ;// 08F0h
   464                              <1> .R13_1:                           resq   1
   464 000008F8 ????????????????    <1>  ;;; .R13_1: resq 1
   465                              <1> ;// 08F8h
   466                              <1> .LT_FT_REGS1:                     resd   1
   466 00000900 ????????            <1>  ;;; .LT_FT_REGS1: resd 1
   467                              <1> ;// 0900h
   468                              <1> .LT_FT_REGS2:                     resd   1
   468 00000904 ????????            <1>  ;;; .LT_FT_REGS2: resd 1
   469                              <1> ;// 0904h
   470                              <1> .R14_0:                           resq FILL64(0x0D80,0x900)
   470 00000908 <res 1144>          <1>  ;;; .R14_0: resq ( ( ( ( 0x0D80 ) - ( 0x900 ) ) / 8 ) - 1 )
   471                              <1> .LT_SEQ_START:                    resq   1
   471 00000D80 ????????????????    <1>  ;;; .LT_SEQ_START: resq 1
   472                              <1> ;// 0D80h
   473                              <1> .R14_2:                           resq   1
   473 00000D88 ????????????????    <1>  ;;; .R14_2: resq 1
   474                              <1> ;// 0D88h
   475                              <1> .LT_SEQ_DONE:                     resq   1
   475 00000D90 ????????????????    <1>  ;;; .LT_SEQ_DONE: resq 1
   476                              <1> ;// 0D90h
   477                              <1> .LT_INCREMENT_3:                  resq   1
   477 00000D98 ????????????????    <1>  ;;; .LT_INCREMENT_3: resq 1
   478                              <1> ;// 0D98h
   479                              <1> .LT_SCRATCHPAD_7:                 resq   1
   479 00000DA0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_7: resq 1
   480                              <1> ;// 0DA0h
   481                              <1> .LT_INCREMENT_4:                  resq   1
   481 00000DA8 ????????????????    <1>  ;;; .LT_INCREMENT_4: resq 1
   482                              <1> ;// 0DA8h
   483                              <1> .LT_SCRATCHPAD_8:                 resq   1
   483 00000DB0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_8: resq 1
   484                              <1> ;// 0DB0h
   485                              <1> .LT_INCREMENT_5:                  resq   1
   485 00000DB8 ????????????????    <1>  ;;; .LT_INCREMENT_5: resq 1
   486                              <1> ;// 0DB8h
   487                              <1> .LT_SCRATCHPAD_9:                 resq   1
   487 00000DC0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_9: resq 1
   488                              <1> ;// 0DC0h
   489                              <1> .LT_INCREMENT_6:                  resq   1
   489 00000DC8 ????????????????    <1>  ;;; .LT_INCREMENT_6: resq 1
   490                              <1> ;// 0DC8h
   491                              <1> .LT_SCRATCHPAD_10:                resq   1
   491 00000DD0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_10: resq 1
   492                              <1> ;// 0DD0h
   493                              <1> .LT_INCREMENT_7:                  resq   1
   493 00000DD8 ????????????????    <1>  ;;; .LT_INCREMENT_7: resq 1
   494                              <1> ;// 0DD8h
   495                              <1> .LT_SCRATCHPAD_11:                resq   1
   495 00000DE0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_11: resq 1
   496                              <1> ;// 0DE0h
   497                              <1> .LT_INCREMENT_8:                  resq   1
   497 00000DE8 ????????????????    <1>  ;;; .LT_INCREMENT_8: resq 1
   498                              <1> ;// 0DE8h
   499                              <1> .LT_SCRATCHPAD_12:                resq   1
   499 00000DF0 ????????????????    <1>  ;;; .LT_SCRATCHPAD_12: resq 1
   500                              <1> ;// 0DF0h
   501                              <1> endstruc
   501                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; TXT_size equ ($-TXT)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   502                              <1> 
   503                              <1> ;MLE_JOIN STRUCTURE
   504                              <1> 
   505                              <1> struc MLE_JOIN
   505                              <2>  ;;; [macro] struc {MLE_JOIN},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::5] %$strucname MLE_JOIN
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; MLE_JOIN:
   506                              <1> .GdtLimit:                        resd 1
   506 00000000 ????????            <1>  ;;; .GdtLimit: resd 1
   507                              <1> .GdtBase:                         resd 1
   507 00000004 ????????            <1>  ;;; .GdtBase: resd 1
   508                              <1> .SegSel:                          resd 1
   508 00000008 ????????            <1>  ;;; .SegSel: resd 1
   509                              <1> .EntryPoint:                      resd 1
   509 0000000C ????????            <1>  ;;; .EntryPoint: resd 1
   510                              <1> endstruc
   510                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; MLE_JOIN_size equ ($-MLE_JOIN)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   511                              <1> 
   512                              <1> ;IDT64GATE STRUCTURE
   513                              <1> 
   514                              <1> struc IDT64GATE
   514                              <2>  ;;; [macro] struc {IDT64GATE},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::8] %$strucname IDT64GATE
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; IDT64GATE:
   515                              <1> .Off31_16_Attr_Sel_Off15_0:       resq   1
   515 00000000 ????????????????    <1>  ;;; .Off31_16_Attr_Sel_Off15_0: resq 1
   516                              <1> .Res_Off63_32:                    resq   1
   516 00000008 ????????????????    <1>  ;;; .Res_Off63_32: resq 1
   517                              <1> endstruc
   517                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; IDT64GATE_size equ ($-IDT64GATE)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   518                              <1> 
   519                              <1> ;COM_DATA STRUCTURE
   520                              <1> 
   521                              <1> struc COM_DATA
   521                              <2>  ;;; [macro] struc {COM_DATA},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::11] %$strucname COM_DATA
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; COM_DATA:
   522                              <1> .Data64Start:             resd 1 ;		      // Offset of 64-bit data start (and Code32End)
   522 00000000 ????????            <1>  ;;; .Data64Start: resd 1
   523                              <1> .Code64Start:             resd 1 ;            // Offset of 64-bit code start
   523 00000004 ????????            <1>  ;;; .Code64Start: resd 1
   524                              <1> .Code64End:               resd 1 ;            // Offset of 64-bit code end
   524 00000008 ????????            <1>  ;;; .Code64End: resd 1
   525                              <1> .Code64Entry:             resd 1 ;            // Offset of 64-bit code entry point
   525 0000000C ????????            <1>  ;;; .Code64Entry: resd 1
   526                              <1> .StkStart:                resd 1 ;            // Offset of stack start
   526 00000010 ????????            <1>  ;;; .StkStart: resd 1
   527                              <1> .Code32Start:             resd 1 ;            // Offset of code segment start.
   527 00000014 ????????            <1>  ;;; .Code32Start: resd 1
   528                              <1> endstruc
   528                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; COM_DATA_size equ ($-COM_DATA)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   529                              <1> 
   530                              <1> ;BIOSAC_COM64_DATA STRUCTURE
   531                              <1> 
   532                              <1> struc BIOSAC_COM64_DATA
   532                              <2>  ;;; [macro] struc {BIOSAC_COM64_DATA},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::14] %$strucname BIOSAC_COM64_DATA
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; BIOSAC_COM64_DATA:
   533                              <1> .Tolud:                   resq   1
   533 00000000 ????????????????    <1>  ;;; .Tolud: resq 1
   534                              <1> .Touud:                   resq   1
   534 00000008 ????????????????    <1>  ;;; .Touud: resq 1
   535                              <1> .AcmBase:                 resd   1
   535 00000010 ????????            <1>  ;;; .AcmBase: resd 1
   536                              <1> .AcmSize:                 resd   1
   536 00000014 ????????            <1>  ;;; .AcmSize: resd 1
   537                              <1> .PdptBase:                resd   1
   537 00000018 ????????            <1>  ;;; .PdptBase: resd 1
   538                              <1> .error64:                 resd   1
   538 0000001C ????????            <1>  ;;; .error64: resd 1
   539                              <1> .Pattern:                 resq YMM_REG_QWORDS
   539 00000020 <res 32>            <1>  ;;; .Pattern: resq 4
   540                              <1> .StrideSize               resd   1
   540 00000040 ????????            <1>  ;;; .StrideSize resd 1
   541                              <1> .Reserved                 resd   1
   541 00000044 ????????            <1>  ;;; .Reserved resd 1
   542                              <1> .shadow_stack_vesp:       resq   1
   542 00000048 ????????????????    <1>  ;;; .shadow_stack_vesp: resq 1
   543                              <1> endstruc
   543                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; BIOSAC_COM64_DATA_size equ ($-BIOSAC_COM64_DATA)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   544                              <1> 
   545                              <1> ;When updating below structure, make sure to update COM64_DATA structure in 
   546                              <1> ;common64.h. If they are not in sync, random sinit failures may be 
   547                              <1> ;seen during resume flows
   548                              <1> 
   549                              <1> ;COM64_DATA STRUCTURE
   550                              <1> 
   551                              <1> struc COM64_DATA
   551                              <2>  ;;; [macro] struc {COM64_DATA},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::17] %$strucname COM64_DATA
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; COM64_DATA:
   552                              <1> 
   553                              <1> .Rc6Mem:                  resq   1
   553 00000000 ????????????????    <1>  ;;; .Rc6Mem: resq 1
   554                              <1> .MediaRc6Mem              resq   1
   554 00000008 ????????????????    <1>  ;;; .MediaRc6Mem resq 1
   555                              <1> .Mdrb:                    resq   1
   555 00000010 ????????????????    <1>  ;;; .Mdrb: resq 1
   556                              <1> .Touud:                   resq   1
   556 00000018 ????????????????    <1>  ;;; .Touud: resq 1
   557                              <1> .Tolud:                   resq   1
   557 00000020 ????????????????    <1>  ;;; .Tolud: resq 1
   558                              <1> .Bgsm:                    resq   1
   558 00000028 ????????????????    <1>  ;;; .Bgsm: resq 1
   559                              <1> .Bdsm:                    resq   1
   559 00000030 ????????????????    <1>  ;;; .Bdsm: resq 1
   560                              <1> .Ggc:                     resq   1
   560 00000038 ????????????????    <1>  ;;; .Ggc: resq 1
   561                              <1> .TsegMb:                  resq   1
   561 00000040 ????????????????    <1>  ;;; .TsegMb: resq 1
   562                              <1> .Dpr:                     resq   1
   562 00000048 ????????????????    <1>  ;;; .Dpr: resq 1
   563                              <1> .Pavpc:                   resq   1
   563 00000050 ????????????????    <1>  ;;; .Pavpc: resq 1
   564                              <1> .PavpcDE                  resq   1
   564 00000058 ????????????????    <1>  ;;; .PavpcDE resq 1
   565                              <1> .PrmrrBase:               resq   1
   565 00000060 ????????????????    <1>  ;;; .PrmrrBase: resq 1
   566                              <1> .PrmrrMask:               resq   1
   566 00000068 ????????????????    <1>  ;;; .PrmrrMask: resq 1
   567                              <1> .Mpmen:                   resd   1
   567 00000070 ????????            <1>  ;;; .Mpmen: resd 1
   568                              <1> .PmrLoBase:               resd   1
   568 00000074 ????????            <1>  ;;; .PmrLoBase: resd 1
   569                              <1> .PmrLoLimit:              resd   1
   569 00000078 ????????            <1>  ;;; .PmrLoLimit: resd 1
   570                              <1> .PmrHiBase:               resd   1
   570 0000007C ????????            <1>  ;;; .PmrHiBase: resd 1
   571                              <1> .PmrHiLimit:              resd   1
   571 00000080 ????????            <1>  ;;; .PmrHiLimit: resd 1
   572                              <1> .GunitCtrl:               resd   1
   572 00000084 ????????            <1>  ;;; .GunitCtrl: resd 1
   573                              <1> .GucWopcmOffset:          resd   1
   573 00000088 ????????            <1>  ;;; .GucWopcmOffset: resd 1
   574                              <1> .GucWopcmSize:            resd   1
   574 0000008C ????????            <1>  ;;; .GucWopcmSize: resd 1
   575                              <1> .GucMediaWopcmOffset:     resd   1
   575 00000090 ????????            <1>  ;;; .GucMediaWopcmOffset: resd 1
   576                              <1> .GucMediaWopcmSize:       resd   1
   576 00000094 ????????            <1>  ;;; .GucMediaWopcmSize: resd 1
   577                              <1> .BtPol:                   resq   1
   577 00000098 ????????????????    <1>  ;;; .BtPol: resq 1
   578                              <1> .BpKey0:                  resq   1
   578 000000A0 ????????????????    <1>  ;;; .BpKey0: resq 1
   579                              <1> .BpKey1:                  resq   1
   579 000000A8 ????????????????    <1>  ;;; .BpKey1: resq 1
   580                              <1> .BpKey2:                  resq   1
   580 000000B0 ????????????????    <1>  ;;; .BpKey2: resq 1
   581                              <1> .BpKey3:                  resq   1
   581 000000B8 ????????????????    <1>  ;;; .BpKey3: resq 1
   582                              <1> .BpKey4:                  resq   1
   582 000000C0 ????????????????    <1>  ;;; .BpKey4: resq 1
   583                              <1> .BpKey5:                  resq   1
   583 000000C8 ????????????????    <1>  ;;; .BpKey5: resq 1
   584                              <1> .Pml4PageDirectoryBase:   resd   1
   584 000000D0 ????????            <1>  ;;; .Pml4PageDirectoryBase: resd 1
   585                              <1> .error64:                 resd   1
   585 000000D4 ????????            <1>  ;;; .error64: resd 1
   586                              <1> .ReqType:                 resb   1
   586 000000D8 ??                  <1>  ;;; .ReqType: resb 1
   587                              <1> .shadow_stack_vesp:       resq   1
   587 000000D9 ????????????????    <1>  ;;; .shadow_stack_vesp: resq 1
   588                              <1> endstruc
   588                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; COM64_DATA_size equ ($-COM64_DATA)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   589                              <1> 
   590                              <1> %if 0
   591                              <1> ;COM64_DATA STRUCTURE
   592                              <1> struc SEAMLDR_COM64_DATA
   593                              <1> 
   594                              <1> .OriginalR8:                  resq   1
   595                              <1> .OriginalR9:	              resq   1
   596                              <1> .OriginalR10:                 resq   1
   597                              <1> .OriginalR11:                 resq   1
   598                              <1> .OriginalR12:                 resq   1
   599                              <1> .OriginalCR3:                 resq   1
   600                              <1> .OriginalCR4:                 resd   1
   601                              <1> .OriginalES:                  resw   1
   602                              <1> .OriginalFS:                  resw   1
   603                              <1> .OriginalGS:                  resw   1
   604                              <1> .OriginalSS:                  resw   1
   605                              <1> .OriginalECX                  resd   1
   606                              <1> .OriginalIDTRLimit:           resw   1
   607                              <1> .NewIDTR:               	  resb   10
   608                              <1> .OriginalGdtr:                resb   10
   609                              <1> .ResumeRip:               	  resq   1
   610                              <1> .PtCtxPtr:                    resq   1
   611                              <1> .RetVal:                      resq   1
   612                              <1> .HeaderStart:                 resq   1
   613                              <1> .PseamldrSize:                resd   1
   614                              <1> .PseamldrOffset:              resq   1
   615                              <1> .PseamldrConstsOffset:     	  resq   1
   616                              <1> .NewGdtr:     				  resb   10
   617                              <1> endstruc
   618                              <1> %endif
   619                              <1> 
   620                              <1> 
   621                              <1> ;GDT32DESCRIPTOR STRUCTURE
   622                              <1> 
   623                              <1> struc GDT32DESCRIPTOR
   623                              <2>  ;;; [macro] struc {GDT32DESCRIPTOR},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::20] %$strucname GDT32DESCRIPTOR
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; GDT32DESCRIPTOR:
   624                              <1> 
   625                              <1> .Limit15_0:               resw    1
   625 00000000 ????                <1>  ;;; .Limit15_0: resw 1
   626                              <1> .Base23_0:                resb    3
   626 00000002 ??????              <1>  ;;; .Base23_0: resb 3
   627                              <1> .Attr:                    resb    1
   627 00000005 ??                  <1>  ;;; .Attr: resb 1
   628                              <1> .Attr_Limit19_16:         resb    1
   628 00000006 ??                  <1>  ;;; .Attr_Limit19_16: resb 1
   629                              <1> .Base31_24:               resb    1
   629 00000007 ??                  <1>  ;;; .Base31_24: resb 1
   630                              <1> 
   631                              <1> endstruc
   631                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; GDT32DESCRIPTOR_size equ ($-GDT32DESCRIPTOR)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   632                              <1> 
   633                              <1> 
   634                              <1> ;GDT STRUCTURE
   635                              <1> 
   636                              <1> struc GDT
   636                              <2>  ;;; [macro] struc {GDT},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::23] %$strucname GDT
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; GDT:
   637                              <1> 
   638                              <1> .NullDescriptor: resb GDT32DESCRIPTOR_size
   638 00000000 ????????????????    <1>  ;;; .NullDescriptor: resb GDT32DESCRIPTOR_size
   639                              <1> .AcmCodeDescriptor: resb GDT32DESCRIPTOR_size
   639 00000008 ????????????????    <1>  ;;; .AcmCodeDescriptor: resb GDT32DESCRIPTOR_size
   640                              <1> .AcmDataDescriptor: resb GDT32DESCRIPTOR_size
   640 00000010 ????????????????    <1>  ;;; .AcmDataDescriptor: resb GDT32DESCRIPTOR_size
   641                              <1> .AcmCode64Descriptor:  resb GDT32DESCRIPTOR_size
   641 00000018 ????????????????    <1>  ;;; .AcmCode64Descriptor: resb GDT32DESCRIPTOR_size
   642                              <1> 
   643                              <1> endstruc
   643                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; GDT_size equ ($-GDT)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   644                              <1> 
   645                              <1> ;RANGE STRUCTURE
   646                              <1> 
   647                              <1> struc RANGE
   647                              <2>  ;;; [macro] struc {RANGE},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::26] %$strucname RANGE
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; RANGE:
   648                              <1> 
   649                              <1> .labl:                    resq   1
   649 00000000 ????????????????    <1>  ;;; .labl: resq 1
   650                              <1> .attr:                    resw   1
   650 00000008 ????                <1>  ;;; .attr: resw 1
   651                              <1> .flags:                   resw   1
   651 0000000A ????                <1>  ;;; .flags: resw 1
   652                              <1> .len:                     resq   1
   652 0000000C ????????????????    <1>  ;;; .len: resq 1
   653                              <1> .base:                    resq   1
   653 00000014 ????????????????    <1>  ;;; .base: resq 1
   654                              <1> .top:                     resq   1
   654 0000001C ????????????????    <1>  ;;; .top: resq 1
   655                              <1> .almtMask:                resq   1
   655 00000024 ????????????????    <1>  ;;; .almtMask: resq 1
   656                              <1> 
   657                              <1> endstruc
   657                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; RANGE_size equ ($-RANGE)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   658                              <1> 
   659                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   660                              <1> ;                       DUMMYS FOR ACM HEADER
   661                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   662                              <1> 
   663                              <1> struc   Dummy_1
   663                              <2>  ;;; [macro] struc {Dummy_1},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::29] %$strucname Dummy_1
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; Dummy_1:
   664                              <1>         .HeaderLen               resd   1
   664 00000000 ????????            <1>  ;;;  .HeaderLen resd 1
   665                              <1>         .HeaderVersion           resd   1
   665 00000004 ????????            <1>  ;;;  .HeaderVersion resd 1
   666                              <1> endstruc
   666                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; Dummy_1_size equ ($-Dummy_1)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   667                              <1> 
   668                              <1> struc   Dummy_2
   668                              <2>  ;;; [macro] struc {Dummy_2},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::32] %$strucname Dummy_2
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; Dummy_2:
   669                              <1>         .ModuleVendor            resd   1
   669 00000000 ????????            <1>  ;;;  .ModuleVendor resd 1
   670                              <1>         .Revision                resd   1
   670 00000004 ????????            <1>  ;;;  .Revision resd 1
   671                              <1>         .Sizeb                   resd   1
   671 00000008 ????????            <1>  ;;;  .Sizeb resd 1
   672                              <1> endstruc
   672                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; Dummy_2_size equ ($-Dummy_2)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   673                              <1> 
   674                              <1> struc   Dummy_3
   674                              <2>  ;;; [macro] struc {Dummy_3},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::35] %$strucname Dummy_3
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; Dummy_3:
   675                              <1>         .CodeControl             resd   1
   675 00000000 ????????            <1>  ;;;  .CodeControl resd 1
   676                              <1>         .ErrorEntryPoint         resd   1
   676 00000004 ????????            <1>  ;;;  .ErrorEntryPoint resd 1
   677                              <1> endstruc
   677                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; Dummy_3_size equ ($-Dummy_3)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   678                              <1> 
   679                              <1> struc   Dummy_4
   679                              <2>  ;;; [macro] struc {Dummy_4},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::38] %$strucname Dummy_4
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; Dummy_4:
   680                              <1>         .Reserved2               resb   64
   680 00000000 <res 64>            <1>  ;;;  .Reserved2 resb 64
   681                              <1>         .KeySize                 resd   1
   681 00000040 ????????            <1>  ;;;  .KeySize resd 1
   682                              <1>         .ScratchSize             resd   1
   682 00000044 ????????            <1>  ;;;  .ScratchSize resd 1
   683                              <1>         .RSA2048PubKey           resb   256
   683 00000048 <res 256>           <1>  ;;;  .RSA2048PubKey resb 256
   684                              <1>         .PubExp                  resd   1
   684 00000148 ????????            <1>  ;;;  .PubExp resd 1
   685                              <1>         .RSA2048Sig              resb   256
   685 0000014C <res 256>           <1>  ;;;  .RSA2048Sig resb 256
   686                              <1>         .scratch                 resb   572
   686 0000024C <res 572>           <1>  ;;;  .scratch resb 572
   687                              <1> endstruc
   687                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; Dummy_4_size equ ($-Dummy_4)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   688                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   689                              <1> 
   690                              <1> 
   691                              <1> 
   692                              <1> ;ACM_HEADER STRUCTURE
   693                              <1> struc ACM_HEADER_0
   693                              <2>  ;;; [macro] struc {ACM_HEADER_0},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::41] %$strucname ACM_HEADER_0
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; ACM_HEADER_0:
   694                              <1> 
   695                              <1> .ModuleType                             resw    1
   695 00000000 ????                <1>  ;;; .ModuleType resw 1
   696                              <1> .ModuleSubType                          resw    1
   696 00000002 ????                <1>  ;;; .ModuleSubType resw 1
   697                              <1> .Dummy_1_var                            resb    Dummy_1_size
   697 00000004 ????????????????    <1>  ;;; .Dummy_1_var resb Dummy_1_size
   698                              <1> .ModuleID                               resw    1
   698 0000000C ????                <1>  ;;; .ModuleID resw 1
   699                              <1> .ModuleFlags                            resw    1
   699 0000000E ????                <1>  ;;; .ModuleFlags resw 1
   700                              <1> .Dummy_2_var                            resb    Dummy_2_size
   700 00000010 <res 12>            <1>  ;;; .Dummy_2_var resb Dummy_2_size
   701                              <1> .AcmSvn                                 resw    1
   701 0000001C ????                <1>  ;;; .AcmSvn resw 1
   702                              <1> .SeSvn                                  resw    1
   702 0000001E ????                <1>  ;;; .SeSvn resw 1
   703                              <1> .Dummy_3_var                            resb    Dummy_3_size
   703 00000020 ????????????????    <1>  ;;; .Dummy_3_var resb Dummy_3_size
   704                              <1> .GDTSize                                resd    1
   704 00000028 ????????            <1>  ;;; .GDTSize resd 1
   705                              <1> .GDTBasePtr                             resd    1
   705 0000002C ????????            <1>  ;;; .GDTBasePtr resd 1
   706                              <1> .SegSel                                 resd    1
   706 00000030 ????????            <1>  ;;; .SegSel resd 1
   707                              <1> .EntryPoint                             resd    1
   707 00000034 ????????            <1>  ;;; .EntryPoint resd 1
   708                              <1> .Dummy_4_var                            resb    Dummy_4_size
   708 00000038 <res 1160>          <1>  ;;; .Dummy_4_var resb Dummy_4_size
   709                              <1> 
   710                              <1> endstruc
   710                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; ACM_HEADER_0_size equ ($-ACM_HEADER_0)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   711                              <1> ;IDT32GATE STRUCTURE
   712                              <1> 
   713                              <1> struc IDT32GATE
   713                              <2>  ;;; [macro] struc {IDT32GATE},{0}
     0                              <2> %push
     0                              <2> %define %$strucname %1
     0                              <2>  ;;; %define [::44] %$strucname IDT32GATE
     0                              <2> [absolute %2]
     0                              <2>  ;;; [absolute 0]
     0                              <2> %$strucname:
     0                              <2>  ;;; IDT32GATE:
   714                              <1> 
   715                              <1> .Off15_0:                 resw    1
   715 00000000 ????                <1>  ;;; .Off15_0: resw 1
   716                              <1> .Sel:                     resw    1
   716 00000002 ????                <1>  ;;; .Sel: resw 1
   717                              <1> .Attr:                    resw    1
   717 00000004 ????                <1>  ;;; .Attr: resw 1
   718                              <1> .Off31_16:                resw    1
   718 00000006 ????                <1>  ;;; .Off31_16: resw 1
   719                              <1> 
   720                              <1> endstruc
   720                              <2>  ;;; [macro] endstruc
     0                              <2> %$strucname_size equ ($-%$strucname)
     0                              <2>  ;;; IDT32GATE_size equ ($-IDT32GATE)
     0                              <2> %pop
     0                              <2> __?SECT?__
     0                              <2>  ;;; [section .text]
   721                              <1> 
   722                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   723                              <1> ;                       FUNCTION PROTOTYPES
   724                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   725                              <1> 
   726                              <1> extern fillMemory
   726                              <2>  ;;; [macro] extern {fillMemory}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern fillMemory]
     0                              <3> %rotate 1
   727                              <1> extern CoreBuildPml4TablesShort
   727                              <2>  ;;; [macro] extern {CoreBuildPml4TablesShort}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern CoreBuildPml4TablesShort]
     0                              <3> %rotate 1
   728                              <1> extern AcmEntryPoint
   728                              <2>  ;;; [macro] extern {AcmEntryPoint}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern AcmEntryPoint]
     0                              <3> %rotate 1
   729                              <1> extern CoreBuildPml4Tables
   729                              <2>  ;;; [macro] extern {CoreBuildPml4Tables}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern CoreBuildPml4Tables]
     0                              <3> %rotate 1
   730                              <1> extern copyMemory
   730                              <2>  ;;; [macro] extern {copyMemory}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern copyMemory]
     0                              <3> %rotate 1
   731                              <1> extern __Wait1ms
   731                              <2>  ;;; [macro] extern {__Wait1ms}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern __Wait1ms]
     0                              <3> %rotate 1
   732                              <1> extern INTErrorHandler
   732                              <2>  ;;; [macro] extern {INTErrorHandler}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern INTErrorHandler]
     0                              <3> %rotate 1
   733                              <1> extern Update_CRx
   733                              <2>  ;;; [macro] extern {Update_CRx}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern Update_CRx]
     0                              <3> %rotate 1
   734                              <1> extern SgxProtection
   734                              <2>  ;;; [macro] extern {SgxProtection}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern SgxProtection]
     0                              <3> %rotate 1
   735                              <1> extern commonAcmEntryPoint
   735                              <2>  ;;; [macro] extern {commonAcmEntryPoint}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern commonAcmEntryPoint]
     0                              <3> %rotate 1
   736                              <1> 
   737                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   738                              <1> ;                       EXTERN VARIABLES
   739                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   740                              <1> 
   741                              <1> extern BiosacCom64Data
   741                              <2>  ;;; [macro] extern {BiosacCom64Data}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern BiosacCom64Data]
     0                              <3> %rotate 1
   742                              <1> extern Com64Data
   742                              <2>  ;;; [macro] extern {Com64Data}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern Com64Data]
     0                              <3> %rotate 1
   743                              <1> extern AcmBase
   743                              <2>  ;;; [macro] extern {AcmBase}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern AcmBase]
     0                              <3> %rotate 1
   744                              <1> extern stackStart
   744                              <2>  ;;; [macro] extern {stackStart}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern stackStart]
     0                              <3> %rotate 1
   745                              <1> extern GdtBasePtr
   745                              <2>  ;;; [macro] extern {GdtBasePtr}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern GdtBasePtr]
     0                              <3> %rotate 1
   746                              <1> extern monitorField
   746                              <2>  ;;; [macro] extern {monitorField}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern monitorField]
     0                              <3> %rotate 1
   747                              <1> extern ilpSmrrBase
   747                              <2>  ;;; [macro] extern {ilpSmrrBase}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern ilpSmrrBase]
     0                              <3> %rotate 1
   748                              <1> extern ilpSmrrMask
   748                              <2>  ;;; [macro] extern {ilpSmrrMask}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern ilpSmrrMask]
     0                              <3> %rotate 1
   749                              <1> extern ilpSmrr2Base
   749                              <2>  ;;; [macro] extern {ilpSmrr2Base}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern ilpSmrr2Base]
     0                              <3> %rotate 1
   750                              <1> extern ilpSmrr2Mask
   750                              <2>  ;;; [macro] extern {ilpSmrr2Mask}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern ilpSmrr2Mask]
     0                              <3> %rotate 1
   751                              <1> extern ilpSmrr2Support
   751                              <2>  ;;; [macro] extern {ilpSmrr2Support}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern ilpSmrr2Support]
     0                              <3> %rotate 1
   752                              <1> extern LocalitiesToCheck
   752                              <2>  ;;; [macro] extern {LocalitiesToCheck}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern LocalitiesToCheck]
     0                              <3> %rotate 1
   753                              <1> extern BspMcuVer
   753                              <2>  ;;; [macro] extern {BspMcuVer}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern BspMcuVer]
     0                              <3> %rotate 1
   754                              <1> extern MlePageTabPhy
   754                              <2>  ;;; [macro] extern {MlePageTabPhy}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern MlePageTabPhy]
     0                              <3> %rotate 1
   755                              <1> extern MleEntryPointPhy
   755                              <2>  ;;; [macro] extern {MleEntryPointPhy}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern MleEntryPointPhy]
     0                              <3> %rotate 1
   756                              <1> extern CodeSegmentStart
   756                              <2>  ;;; [macro] extern {CodeSegmentStart}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern CodeSegmentStart]
     0                              <3> %rotate 1
   757                              <1> extern AcmSize
   757                              <2>  ;;; [macro] extern {AcmSize}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern AcmSize]
     0                              <3> %rotate 1
   758                              <1> extern AcmTop
   758                              <2>  ;;; [macro] extern {AcmTop}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern AcmTop]
     0                              <3> %rotate 1
   759                              <1> extern OriginalIDTR
   759                              <2>  ;;; [macro] extern {OriginalIDTR}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalIDTR]
     0                              <3> %rotate 1
   760                              <1> extern OriginalEIP
   760                              <2>  ;;; [macro] extern {OriginalEIP}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalEIP]
     0                              <3> %rotate 1
   761                              <1> extern OriginalEAX
   761                              <2>  ;;; [macro] extern {OriginalEAX}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalEAX]
     0                              <3> %rotate 1
   762                              <1> extern OriginalESI
   762                              <2>  ;;; [macro] extern {OriginalESI}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalESI]
     0                              <3> %rotate 1
   763                              <1> extern OriginalEDI
   763                              <2>  ;;; [macro] extern {OriginalEDI}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalEDI]
     0                              <3> %rotate 1
   764                              <1> extern OriginalECX
   764                              <2>  ;;; [macro] extern {OriginalECX}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalECX]
     0                              <3> %rotate 1
   765                              <1> extern OriginalEDX
   765                              <2>  ;;; [macro] extern {OriginalEDX}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalEDX]
     0                              <3> %rotate 1
   766                              <1> extern OriginalCR4
   766                              <2>  ;;; [macro] extern {OriginalCR4}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalCR4]
     0                              <3> %rotate 1
   767                              <1> extern OriginalES
   767                              <2>  ;;; [macro] extern {OriginalES}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalES]
     0                              <3> %rotate 1
   768                              <1> extern OriginalFS
   768                              <2>  ;;; [macro] extern {OriginalFS}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalFS]
     0                              <3> %rotate 1
   769                              <1> extern OriginalGS
   769                              <2>  ;;; [macro] extern {OriginalGS}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalGS]
     0                              <3> %rotate 1
   770                              <1> extern OriginalSS
   770                              <2>  ;;; [macro] extern {OriginalSS}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalSS]
     0                              <3> %rotate 1
   771                              <1> extern SeamldrCom64Data
   771                              <2>  ;;; [macro] extern {SeamldrCom64Data}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern SeamldrCom64Data]
     0                              <3> %rotate 1
   772                              <1> extern OriginalIDTRLimit
   772                              <2>  ;;; [macro] extern {OriginalIDTRLimit}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern OriginalIDTRLimit]
     0                              <3> %rotate 1
   773                              <1> extern HeaderStart
   773                              <2>  ;;; [macro] extern {HeaderStart}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern HeaderStart]
     0                              <3> %rotate 1
   774                              <1> extern shadow_stack_vesp
   774                              <2>  ;;; [macro] extern {shadow_stack_vesp}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern shadow_stack_vesp]
     0                              <3> %rotate 1
   775                              <1> extern shadow_stack_vesp64
   775                              <2>  ;;; [macro] extern {shadow_stack_vesp64}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern shadow_stack_vesp64]
     0                              <3> %rotate 1
   776                              <1> extern shadow_stack_vesp64_bottom
   776                              <2>  ;;; [macro] extern {shadow_stack_vesp64_bottom}
     0                              <2> %rep %0
     0                              <2> [extern %1]
     0                              <2> %rotate 1
     0                              <2> %endrep
     0                              <3> [extern %1]
     0                              <3>  ;;; [extern shadow_stack_vesp64_bottom]
     0                              <3> %rotate 1
   777                              <1> 
   778                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   779                              <1> ;                       Helper macros
   780                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   781                              <1> 
   782                              <1> 
   783                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   784                              <1> ;            Implementation of if and else Macros
   785                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   786                              <1> 
   787                              <1> %macro IF 1
   788                              <1> 
   789                              <1>         %push IF
   790                              <1>         j%-1  %$ifnot
   791                              <1> 
   792                              <1> %endmacro
   793                              <1> 
   794                              <1> %macro ELSE 0
   795                              <1> 
   796                              <1>   %ifctx IF
   797                              <1>         %repl   else
   798                              <1>         jmp     %$ifend
   799                              <1>         %$ifnot:
   800                              <1>   %else
   801                              <1>         %error  "expected IF before ELSE"
   802                              <1>   %endif
   803                              <1> 
   804                              <1> %endmacro
   805                              <1> 
   806                              <1> %macro ENDIF 0
   807                              <1> 
   808                              <1>   %ifctx IF
   809                              <1>         %$ifnot:
   810                              <1>         %pop
   811                              <1>   %elifctx  else
   812                              <1>         %$ifend:
   813                              <1>         %pop
   814                              <1>   %else
   815                              <1>         %error  "expected IF or ELSE before ENDIF"
   816                              <1>   %endif
   817                              <1> 
   818                              <1> %endmacro
   819                              <1> 
   820                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   821                              <1> ;  Implementation of Repeat Macro
   822                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   823                              <1> 
   824                              <1> %macro REPEAT 0
   825                              <1> 
   826                              <1>     %push   REPEAT
   827                              <1>     %$begin:
   828                              <1> 
   829                              <1> %endmacro
   830                              <1> 
   831                              <1> %macro UNTIL_FOREVER 0
   832                              <1>         jmp    %$begin
   833                              <1> %$break:
   834                              <1>     %pop
   835                              <1> 
   836                              <1> %endmacro
   837                              <1> 
   838                              <1> %macro UNTIL 3
   839                              <1>         cmp %1,%3
   840                              <1>         j%-2    %$begin
   841                              <1> %$break:
   842                              <1>     %pop
   843                              <1> 
   844                              <1> %endmacro
   845                              <1> 
   846                              <1> %macro UNTILCXZ 0
   847                              <1> 
   848                              <1>         loop    %$begin
   849                              <1> %$break:
   850                              <1>     %pop
   851                              <1> 
   852                              <1> %endmacro
   853                              <1> 
   854                              <1> %macro UNTILCXNZ 0
   855                              <1> 
   856                              <1>         loop    %$begin
   857                              <1> %$break:
   858                              <1>     %pop
   859                              <1> 
   860                              <1> %endmacro
   861                              <1> 
   862                              <1> 
   863                              <1> %macro BREAK_IF_EQUAL 2
   864                              <1> 	%ifctx REPEAT
   865                              <1>                 cmp %1,%2
   866                              <1>                 je %$break
   867                              <1> 	%else
   868                              <1> 		%fatal "BREAK_IF must be inside REPEAT"
   869                              <1> 	%endif
   870                              <1> %endmacro
   871                              <1> 
   872                              <1> %macro BREAK_IF_NOTEQUAL 2
   873                              <1> 	%ifctx REPEAT
   874                              <1>                 cmp %1,%2
   875                              <1>                 jne %$break
   876                              <1> 	%else
   877                              <1> 		%fatal "BREAK_IF must be inside REPEAT"
   878                              <1> 	%endif
   879                              <1> %endmacro
   880                              <1> 
   881                              <1> %macro BREAK_IF_ZERO 0
   882                              <1> 	%ifctx REPEAT
   883                              <1>                 je %$break
   884                              <1> 	%else
   885                              <1> 		%fatal "BREAK_IF must be inside REPEAT"
   886                              <1> 	%endif
   887                              <1> %endmacro
   888                              <1> 
   889                              <1> %macro BREAK_IF_NOT_ZERO 0
   890                              <1> 	%ifctx REPEAT
   891                              <1>                 jne %$break
   892                              <1> 	%else
   893                              <1> 		%fatal "BREAK_IF must be inside REPEAT"
   894                              <1> 	%endif
   895                              <1> %endmacro
   896                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   897                              <1> ;  Implementation of MULTIPUSH and MULTIPOP Macro
   898                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   899                              <1> 
   900                              <1> 
   901                              <1> %macro  MULTIPUSH 1-*
   902                              <1> 
   903                              <1>   %rep  %0
   904                              <1>         push    %1
   905                              <1>   %rotate 1
   906                              <1>   %endrep
   907                              <1> 
   908                              <1> %endmacro
   909                              <1> 
   910                              <1> %macro  MULTIPOP 1-*
   911                              <1> 
   912                              <1>   %rep %0
   913                              <1>   %rotate -1
   914                              <1>         pop     %1
   915                              <1>   %endrep
   916                              <1> 
   917                              <1> %endmacro
   918                              <1> 
   919                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   920                              <1> ;  Implementation of PROLOGUE and EPILOGUE  Macro
   921                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   922                              <1> %macro  PROLOGUE 1
   923                              <1>         push    ebp
   924                              <1>         mov     ebp,esp
   925                              <1>         sub     esp,%1
   926                              <1> %endmacro
   927                              <1> 
   928                              <1> %macro  PROLOGUE 0
   929                              <1>         push    ebp
   930                              <1>         mov     ebp,esp
   931                              <1> %endmacro
   932                              <1> 
   933                              <1> %macro  EPILOGUE  0
   934                              <1>         leave
   935                              <1>         ret
   936                              <1> %endmacro
   937                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   938                              <1> ;  Implementation of DEBUG_BREAK_POINT Macro define DEBUG before using
   939                              <1> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   940                              <1> 
   941                              <1> %ifdef DEBUG
   942                              <1> 
   943                              <1> %macro DEBUG_BREAK_POINT 0
   944                              <1>         jmp     $
   945                              <1> %endmacro
   946                              <1> 
   947                              <1> %macro PRINT_TO_PORT 1
   948                              <1>         push ax
   949                              <1>         mov ax, %1
   950                              <1>         out PORT80, ax
   951                              <1>         pop ax
   952                              <1> %endmacro
   953                              <1> 
   954                              <1> %else
   955                              <1> %macro DEBUG_BREAK_POINT  0
   956                              <1> %endmacro
   957                              <1> 
   958                              <1> %macro PRINT_TO_PORT 1
   959                              <1> %endmacro
   960                              <1> 
   961                              <1> %endif
   962                              <1> 
   963                              <1> %endif
    21                                  
    22                                  
    23                                  section EDATA32 data write PUBLIC
    23                              <1>  ;;; [macro] section {EDATA32 data write PUBLIC}
     0                              <1> %define __?SECT?__ [section %1]
     0                              <1>  ;;; %define __?SECT?__ [section EDATA32 data write PUBLIC]
     0                              <1> __?SECT?__
     0                              <1>  ;;; [section EDATA32 data write PUBLIC]
    24                                  
    25                                          ALIGN 16
    25                              <1>  ;;; [macro] ALIGN {16},{nop}
     0                              <1> %if __?SECTALIGN_ALIGN_UPDATES_SECTION?__
     0                              <1> sectalign %1
     0                              <2>  ;;; [macro] sectalign {16}
     0                              <2> %ifidni %1,off
     0                              <2> %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 0
     0                              <2> %elifidni %1,on
     0                              <2> %define __?SECTALIGN_ALIGN_UPDATES_SECTION?__ 1
     0                              <2> %else
     0                              <2> [sectalign %1]
     0                              <2>  ;;; [sectalign 16]
     0                              <2> %endif
     0                              <1> %endif
     0                              <1> times (((%1) - (($-$$) % (%1))) % (%1)) %2
     0                              <1>  ;;; times (((16) - (($-$$) % (16))) % (16)) nop
    26                                  
    27                                      CodeSegmentStart:    dd  00 ; size of ACM data + stack
    27 00000000 00000000                 ;;;  CodeSegmentStart: dd 00
    28                                  
    29                                      OriginalIDTR:    dq  00h         ; Original IDTR Limit/Base
    29 00000004 0000000000000000         ;;;  OriginalIDTR: dq 00h
    30                                      OriginalEIP:     dd  00h
    30 0000000C 00000000                 ;;;  OriginalEIP: dd 00h
    31                                      OriginalEAX:     dd  00h
    31 00000010 00000000                 ;;;  OriginalEAX: dd 00h
    32                                      OriginalEBX:     dd  00h    
    32 00000014 00000000                 ;;;  OriginalEBX: dd 00h
    33                                      OriginalECX:     dd  00h
    33 00000018 00000000                 ;;;  OriginalECX: dd 00h
    34                                      OriginalESI:     dd  00h
    34 0000001C 00000000                 ;;;  OriginalESI: dd 00h
    35                                      OriginalEDI:     dd  00h
    35 00000020 00000000                 ;;;  OriginalEDI: dd 00h
    36                                      OriginalEDX:     dd  00h
    36 00000024 00000000                 ;;;  OriginalEDX: dd 00h
    37                                      OriginalCR3:     dd  00h
    37 00000028 00000000                 ;;;  OriginalCR3: dd 00h
    38                                      OriginalCR4:     dd  00h    
    38 0000002C 00000000                 ;;;  OriginalCR4: dd 00h
    39                                      OriginalES:      dw 00h
    39 00000030 0000                     ;;;  OriginalES: dw 00h
    40                                      OriginalFS:      dw 00h
    40 00000032 0000                     ;;;  OriginalFS: dw 00h
    41                                      OriginalGS:      dw 00h
    41 00000034 0000                     ;;;  OriginalGS: dw 00h
    42                                      OriginalSS:      dw 00h        
    42 00000036 0000                     ;;;  OriginalSS: dw 00h
    43                                  
    44                                  
    45                                      ;PUBLIC R_ACM
    46                                      global R_ACM
    46                              <1>  ;;; [macro] global {R_ACM}
     0                              <1> %rep %0
     0                              <1> [global %1]
     0                              <1> %rotate 1
     0                              <1> %endrep
     0                              <2> [global %1]
     0                              <2>  ;;; [global R_ACM]
     0                              <2> %rotate 1
    47                                      R_ACM:              dq  LBL_ACM
    47 00000038 0100000000000000         ;;;  R_ACM: dq 0x1
    48                                                          dw  0
    48 00000040 0000                     ;;;  dw 0
    49                                                          dw  RFA_VALID
    49 00000042 0080                     ;;;  dw 0x8000
    50                                      AcmSize:            dd  00h         ; Size of currently running ACM
    50 00000044 00000000                 ;;;  AcmSize: dd 00h
    51                                                          dd  0
    51 00000048 00000000                 ;;;  dd 0
    52                                      AcmBase:            dd  00h         ; Base address of where ACM is in memory
    52 0000004C 00000000                 ;;;  AcmBase: dd 00h
    53                                                          dd  0
    53 00000050 00000000                 ;;;  dd 0
    54                                      AcmTop:             dd  00h         ; End address of ACM in memory
    54 00000054 00000000                 ;;;  AcmTop: dd 00h
    55                                                          dd  0
    55 00000058 00000000                 ;;;  dd 0
    56                                                          dq  _4KB_MASK
    56 0000005C 00F0FFFFFFFFFFFF         ;;;  dq ( ~ ( 0x1000 - 1 ) )
    57                                  
    58                                          
    59                                  ;----------------------------------------------------------------------------
    60                                  ;       C O D E     S E G M E N T
    61                                  ;----------------------------------------------------------------------------
    62                                  section .text$mn code PUBLIC align=1 USE32
    62                              <1>  ;;; [macro] section {.text$mn code PUBLIC align=1 USE32}
     0                              <1> %define __?SECT?__ [section %1]
     0                              <1>  ;;; %define __?SECT?__ [section .text$mn code PUBLIC align=1 USE32]
     0                              <1> __?SECT?__
     0                              <1>  ;;; [section .text$mn code PUBLIC align=1 USE32]
    63                                          ;
    64                                          ; Don't destroy the following values.
    65                                          ; ACM_PE2BIN tool reads [sinitAcmStart - 8] and interprets it
    66                                          ; as offset of image where to store relocation table
    67                                          ; ACM_PE2BIN tool stores offset of the beginning of CODE32 segment in
    68                                          ; [sinitAcmStart - 4] for ACM code use.
    69                                          ; Initializing of [sinitAcmStart - x] = offset HeaderStart is
    70                                          ; equivalent to initializing it as [sinitAcmStart - x] = 0 but with
    71                                          ; side effect that offset of sinitAcmStart - x is inserted into
    72                                          ; relocation table and is fixed-up by fix-up loop.
    73                                          ; Code makes use of this effect.
    74                                          ;
    75                                      istruc COM_DATA
    75                              <1>  ;;; [macro] istruc {COM_DATA}
     0                              <1> %push
     0                              <1> %define %$strucname %1
     0                              <1>  ;;; %define [::98] %$strucname COM_DATA
     0                              <1> %$strucstart:
     0                              <1>  ;;; ..@98.strucstart:
    76                                      at COM_DATA.Data64Start,      dd       HeaderStart
    76                              <1>  ;;; [macro] at {COM_DATA.Data64Start},{dd HeaderStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.Data64Start-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 00000000 [00000000]          <1>  ;;; dd HeaderStart
    77                                      at COM_DATA.Code64Start,      dd       HeaderStart
    77                              <1>  ;;; [macro] at {COM_DATA.Code64Start},{dd HeaderStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.Code64Start-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 00000004 [00000000]          <1>  ;;; dd HeaderStart
    78                                      at COM_DATA.Code64End,        dd       HeaderStart
    78                              <1>  ;;; [macro] at {COM_DATA.Code64End},{dd HeaderStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.Code64End-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 00000008 [00000000]          <1>  ;;; dd HeaderStart
    79                                      at COM_DATA.Code64Entry,      dd       HeaderStart
    79                              <1>  ;;; [macro] at {COM_DATA.Code64Entry},{dd HeaderStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.Code64Entry-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 0000000C [00000000]          <1>  ;;; dd HeaderStart
    80                                      at COM_DATA.StkStart,         dd       stackStart
    80                              <1>  ;;; [macro] at {COM_DATA.StkStart},{dd stackStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.StkStart-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 00000010 [00000000]          <1>  ;;; dd stackStart
    81                                      at COM_DATA.Code32Start,      dd       HeaderStart
    81                              <1>  ;;; [macro] at {COM_DATA.Code32Start},{dd HeaderStart}
     0                              <1> times (%1-%$strucname)-($-%$strucstart) db 0
     0                              <1>  ;;; times (COM_DATA.Code32Start-COM_DATA)-($-..@98.strucstart) db 0
     0                              <1> %2
     0 00000014 [00000000]          <1>  ;;; dd HeaderStart
    82                                      iend
    82                              <1>  ;;; [macro] iend
     0                              <1> times %$strucname_size-($-%$strucstart) db 0
     0                              <1>  ;;; times COM_DATA_size-($-..@98.strucstart) db 0
     0                              <1> %pop
    83                                  
    84                                  ;-----------------------------------------------------------------------------
    85                                  ;-----------------------------------------------------------------------------
    86                                  ;  Procedure:	AcmEntryPoint
    87                                  ; 
    88                                  ;  Input:	State after GETSEC[SENTER|ENTERACCS] instruction
    89                                  ; 
    90                                  ;  Output:	None
    91                                  ; 
    92                                  ;  Description:	Performs fix-ups; transfers control to project-specific
    93                                  ;               entry point
    94                                  ; 
    95                                  ;-----------------------------------------------------------------------------
    96                                  ;-----------------------------------------------------------------------------
    97                                  AcmEntryPoint :
    97                                   ;;; AcmEntryPoint :
    98                                          nop
    98 00000018 90                       ;;;  nop
    99                                          nop
    99 00000019 90                       ;;;  nop
   100                                          nop
   100 0000001A 90                       ;;;  nop
   101                                  
   102                                  
   103                                          ; Right after ENTERACCS, SEAMLDR 32-bit assembly code will do the following:
   104                                          ; SIDT saved_OS_IDTR
   105                                          ; LIDT null_IDTR // a 48-bit variable that contains 0's
   106                                          sidt    [ds:(ebp + stackStart + 4*6)]
   106 0000001B 3E0F018D[18000000]       ;;;  sidt [ds:(ebp + stackStart + 4*6)]
   107                                  
   108                                          mov     dword [ds:(ebp + stackStart + 4)], 0       ; Make sure that Null IDTR is actually zero
   108 00000023 3EC785[04000000]00-      ;;;  mov dword [ds:(ebp + stackStart + 4)], 0
   108 0000002B 000000             
   109                                          mov     dword  [ds:(ebp + stackStart + 4 + 4)], 0
   109 0000002E 3EC785[08000000]00-      ;;;  mov dword [ds:(ebp + stackStart + 4 + 4)], 0
   109 00000036 000000             
   110                                          lidt    [ds:(ebp + stackStart + 4)]          ; Load NULL IDTR
   110 00000039 3E0F019D[04000000]       ;;;  lidt [ds:(ebp + stackStart + 4)]
   111                                          
   112                                          cmp     eax, ENTERACCS
   112 00000041 83F802                   ;;;  cmp eax, 2
   113                                          jz     _IS_ENTERACCS        
   113 00000044 7402                     ;;;  jz _IS_ENTERACCS
   114                                          ud2
   114 00000046 0F0B                     ;;;  ud2
   115                                          _IS_ENTERACCS:        
   115                                   ;;;  _IS_ENTERACCS:
   116                                          lfence
   116 00000048 0FAEE8                   ;;;  lfence
   117                                      
   118                                  
   119                                  
   120                                          ;
   121                                          ; Save registers to Fixup scratch area (size of 40h bytes reserved for fixup routine use)
   122                                          ;
   123                                          mov     dword  [ds:(ebp + stackStart + 4*0)], eax
   123 0000004B 3E8985[00000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*0)], eax
   124                                          mov     dword  [ds:(ebp + stackStart + 4*1)], ebx
   124 00000052 3E899D[04000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*1)], ebx
   125                                          mov     dword  [ds:(ebp + stackStart + 4*2)], ecx
   125 00000059 3E898D[08000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*2)], ecx
   126                                          mov     dword  [ds:(ebp + stackStart + 4*3)], edx
   126 00000060 3E8995[0C000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*3)], edx
   127                                          mov     dword  [ds:(ebp + stackStart + 4*4)], esi
   127 00000067 3E89B5[10000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*4)], esi
   128                                          mov     dword  [ds:(ebp + stackStart + 4*5)], edi
   128 0000006E 3E89BD[14000000]         ;;;  mov dword [ds:(ebp + stackStart + 4*5)], edi
   129                                  
   130                                  
   131                                          ;
   132                                          ; SE_SVN should be written as soon as possible
   133                                          ;
   134                                  
   135                                          mov     ecx, MSR_BIOS_SE_SVN
   135 00000075 B902030000               ;;;  mov ecx, 0x302
   136                                          rdmsr
   136 0000007A 0F32                     ;;;  rdmsr
   137                                  
   138                                          ; bits [63:56] (upper 8 bits of EDX) of SE_SVN MSR are the SEAMLDR_SVN that we want to write
   139                                  
   140                                          and     edx, 000FFFFFFh
   140 0000007C 81E2FFFFFF00             ;;;  and edx, 000FFFFFFh
   141                                          xor     ebx, ebx
   141 00000082 31DB                     ;;;  xor ebx, ebx
   142                                          mov     bx, word [ds:(ebp + ACM_HEADER_0.SeSvn)]         
   142 00000084 3E668B5D1E               ;;;  mov bx, word [ds:(ebp + ACM_HEADER_0.SeSvn)]
   143                                          ; SeSvn is 16 bits - don't overwrite another component's svn
   144                                          shl     ebx, 24
   144 00000089 C1E318                   ;;;  shl ebx, 24
   145                                          or      edx, ebx
   145 0000008C 09DA                     ;;;  or edx, ebx
   146                                  
   147                                          ; Need to clear lower 8 bits containing patch-at-reset SE_SVN value, not writable and will GP if written with !0 value.
   148                                  
   149                                          and     eax, 0FFFFFF00h
   149 0000008E 2500FFFFFF               ;;;  and eax, 0FFFFFF00h
   150                                          wrmsr
   150 00000093 0F30                     ;;;  wrmsr
   151                                             
   152                                  
   153                                          mov     ecx, MSR_BIOS_DONE
   153 00000095 B951010000               ;;;  mov ecx, 0x151
   154                                          rdmsr
   154 0000009A 0F32                     ;;;  rdmsr
   155                                          test    eax, 1
   155 0000009C A901000000               ;;;  test eax, 1
   156                                          jnz _BIOS_DONE_LOCKED
   156 000000A1 7502                     ;;;  jnz _BIOS_DONE_LOCKED
   157                                          db      0Fh, 0Bh                ; ud2
   157 000000A3 0F0B                     ;;;  db 0Fh, 0Bh
   158                                          
   159                                          _BIOS_DONE_LOCKED:
   159                                   ;;;  _BIOS_DONE_LOCKED:
   160                                  
   161                                  
   162                                          mov     esi, stackStart+40h
   162 000000A5 BE[40000000]             ;;;  mov esi, stackStart+40h
   163                                          add     esi, ebp                ; point to ACM reloc table for fixup
   163 000000AA 01EE                     ;;;  add esi, ebp
   164                                          mov     ecx, dword [esi] ; get relocCount
   164 000000AC 8B0E                     ;;;  mov ecx, dword [esi]
   165                                  
   166                                          ; Update this section of code for 18 bits of relocation data for 256KB ACM size support
   167                                          or          ecx,ecx
   167 000000AE 09C9                     ;;;  or ecx,ecx
   168                                          IF ne                           ; Test for IF ecx != 0 condition
   168                              <1>  ;;; [macro] IF {ne}
   788                              <1> 
   789                              <1>  %push IF
   790                              <1>  j%-1 %$ifnot
   790 000000B0 742D                <1>  ;;;  je ..@107.ifnot
   791                              <1> 
   169                                            xor     edx, edx              ; # bits to shift right (Shift Right counter)
   169 000000B2 31D2                     ;;;  xor edx, edx
   170                                            add     esi, 4                ; point to 1st relocAddr
   170 000000B4 83C604                   ;;;  add esi, 4
   171                                            mov     ebx, 3FFFFh           ; For clipping to lower 18 bits
   171 000000B7 BBFFFF0300               ;;;  mov ebx, 3FFFFh
   172                                  
   173                                            xor     eax, eax
   173 000000BC 31C0                     ;;;  xor eax, eax
   174                                  FixupLoop:
   174                                   ;;; FixupLoop:
   175                                            mov     edi, dword [esi] ; get relocAddr
   175 000000BE 8B3E                     ;;;  mov edi, dword [esi]
   176                                            xchg    ecx, edx              ; Keep ecx = Shift Right count
   176 000000C0 87CA                     ;;;  xchg ecx, edx
   177                                            shr     edi, cl               ; Shifting right by Shift Right count
   177 000000C2 D3EF                     ;;;  shr edi, cl
   178                                            and     edi, ebx              ; Clipped to lower 18 bits
   178 000000C4 21DF                     ;;;  and edi, ebx
   179                                            add     dword [ds:(ebp+edi)], ebp ; fix it up
   179 000000C6 3E016C3D00               ;;;  add dword [ds:(ebp+edi)], ebp
   180                                            xchg    ecx, edx              ; Restoring ecx
   180 000000CB 87CA                     ;;;  xchg ecx, edx
   181                                  
   182                                            add     edx,2                 ; Increment Shift Right counter
   182 000000CD 83C202                   ;;;  add edx,2
   183                                            and     edx, 0Fh              ; Clipped Shift Right counter to 0-15 count
   183 000000D0 83E20F                   ;;;  and edx, 0Fh
   184                                  
   185                                            add     esi, 2                ; point to next relocAddr
   185 000000D3 83C602                   ;;;  add esi, 2
   186                                            or      edx,edx
   186 000000D6 09D2                     ;;;  or edx,edx
   187                                            IF e                          ; Test for  IF edx == 0
   187                              <1>  ;;; [macro] IF {e}
   788                              <1> 
   789                              <1>  %push IF
   790                              <1>  j%-1 %$ifnot
   790 000000D8 7503                <1>  ;;;  jne ..@109.ifnot
   791                              <1> 
   188                                              add     esi, 2              ; Adjust relocAddr for proper alignment if Shift Right counter == 0
   188 000000DA 83C602                   ;;;  add esi, 2
   189                                            ENDIF
   189                              <1>  ;;; [macro] ENDIF
   807                              <1> 
   808                              <1>  %ifctx IF
   809                              <1>  %$ifnot:
   809                              <1>  ;;;  ..@109.ifnot:
   810                              <1>  %pop
   811                              <1>  %elifctx else
   812                              <1>  %$ifend:
   813                              <1>  %pop
   814                              <1>  %else
   815                              <1>  %error "expected IF or ELSE before ENDIF"
   816                              <1>  %endif
   817                              <1> 
   190                                  
   191                                            loop    FixupLoop
   191 000000DD E2DF                     ;;;  loop FixupLoop
   192                                  
   193                                            %ifdef MF_ATOM_SUPPORT
   194                                            mov ecx, MSR_CACHE_FLUSH
   195                                            mov eax, CACHE_FLUSH_CMD
   196                                            mov edx, 0
   197                                            wrmsr
   198                                            %endif
   199                                  
   200                                          ENDIF
   200                              <1>  ;;; [macro] ENDIF
   807                              <1> 
   808                              <1>  %ifctx IF
   809                              <1>  %$ifnot:
   809                              <1>  ;;;  ..@107.ifnot:
   810                              <1>  %pop
   811                              <1>  %elifctx else
   812                              <1>  %$ifend:
   813                              <1>  %pop
   814                              <1>  %else
   815                              <1>  %error "expected IF or ELSE before ENDIF"
   816                              <1>  %endif
   817                              <1> 
   201                                          
   202                                            lfence
   202 000000DF 0FAEE8                   ;;;  lfence
   203                                          
   204                                          ;
   205                                          ; Find offset of code segment start, updated by ACM_PE2BIN tool
   206                                          ; Also serves as stack end
   207                                          ;
   208                                          mov     esi, AcmEntryPoint
   208 000000E2 BE[18000000]             ;;;  mov esi, AcmEntryPoint
   209                                          mov     eax, [cs:((esi - COM_DATA_size) + COM_DATA.Code32Start)]
   209 000000E7 2E8B46FC                 ;;;  mov eax, [cs:((esi - COM_DATA_size) + COM_DATA.Code32Start)]
   210                                          mov     [CodeSegmentStart], eax
   210 000000EB A3[00000000]             ;;;  mov [CodeSegmentStart], eax
   211                                          ;
   212                                          ; Restore registers from Fixup scratch area (size of 40h bytes reserved for fixup routine use)
   213                                          ;
   214                                          mov     eax, DWORD  [(stackStart + 4*0)]
   214 000000F0 A1[00000000]             ;;;  mov eax, DWORD [(stackStart + 4*0)]
   215                                          mov     ebx, DWORD  [(stackStart + 4*1)]
   215 000000F5 8B1D[04000000]           ;;;  mov ebx, DWORD [(stackStart + 4*1)]
   216                                          mov     ecx, DWORD  [(stackStart + 4*2)]
   216 000000FB 8B0D[08000000]           ;;;  mov ecx, DWORD [(stackStart + 4*2)]
   217                                          mov     edx, DWORD  [(stackStart + 4*3)]
   217 00000101 8B15[0C000000]           ;;;  mov edx, DWORD [(stackStart + 4*3)]
   218                                          mov     esi, DWORD  [(stackStart + 4*4)]
   218 00000107 8B35[10000000]           ;;;  mov esi, DWORD [(stackStart + 4*4)]
   219                                          mov     edi, DWORD  [(stackStart + 4*5)]
   219 0000010D 8B3D[14000000]           ;;;  mov edi, DWORD [(stackStart + 4*5)]
   220                                  
   221                                          mov     [OriginalEIP], ebx
   221 00000113 891D[0C000000]           ;;;  mov [OriginalEIP], ebx
   222                                          mov     [OriginalEAX], eax
   222 00000119 A3[10000000]             ;;;  mov [OriginalEAX], eax
   223                                  		mov     [OriginalECX], ecx
   223 0000011E 890D[18000000]           ;;;  mov [OriginalECX], ecx
   224                                          mov     [OriginalESI], esi
   224 00000124 8935[1C000000]           ;;;  mov [OriginalESI], esi
   225                                          mov     [OriginalEDI], edi
   225 0000012A 893D[20000000]           ;;;  mov [OriginalEDI], edi
   226                                          mov     [OriginalEDX], edx
   226 00000130 8915[24000000]           ;;;  mov [OriginalEDX], edx
   227                                          mov     eax, DWORD [(stackStart + 4*6)]
   227 00000136 A1[18000000]             ;;;  mov eax, DWORD [(stackStart + 4*6)]
   228                                          mov     [OriginalIDTR], eax
   228 0000013B A3[04000000]             ;;;  mov [OriginalIDTR], eax
   229                                          mov     eax, DWORD [(stackStart + 4*7)]
   229 00000140 A1[1C000000]             ;;;  mov eax, DWORD [(stackStart + 4*7)]
   230                                          mov     [OriginalIDTR + 4], eax        
   230 00000145 A3[08000000]             ;;;  mov [OriginalIDTR + 4], eax
   231                                  
   232                                          mov	    eax, cr4
   232 0000014A 0F20E0                   ;;;  mov eax, cr4
   233                                          mov     [OriginalCR4], eax
   233 0000014D A3[2C000000]             ;;;  mov [OriginalCR4], eax
   234                                          mov	    eax, cr3
   234 00000152 0F20D8                   ;;;  mov eax, cr3
   235                                          mov     [OriginalCR3], eax         
   235 00000155 A3[28000000]             ;;;  mov [OriginalCR3], eax
   236                                  
   237                                          ;                      
   238                                          ; Initialize Stack and Extended Data segments
   239                                          ;
   240                                          mov     ax, ES
   240 0000015A 668CC0                   ;;;  mov ax, ES
   241                                          mov     [OriginalES], ax
   241 0000015D 66A3[30000000]           ;;;  mov [OriginalES], ax
   242                                          mov     ax, FS
   242 00000163 668CE0                   ;;;  mov ax, FS
   243                                          mov     [OriginalFS], ax
   243 00000166 66A3[32000000]           ;;;  mov [OriginalFS], ax
   244                                          mov     ax, GS
   244 0000016C 668CE8                   ;;;  mov ax, GS
   245                                          mov     [OriginalGS], ax
   245 0000016F 66A3[34000000]           ;;;  mov [OriginalGS], ax
   246                                          mov     ax, SS
   246 00000175 668CD0                   ;;;  mov ax, SS
   247                                          mov     [OriginalSS], ax        
   247 00000178 66A3[36000000]           ;;;  mov [OriginalSS], ax
   248                                          mov     ax, ACM_DATA_SELECTOR
   248 0000017E 66B81000                 ;;;  mov ax, 16
   249                                          mov     es, ax
   249 00000182 8EC0                     ;;;  mov es, ax
   250                                          mov     fs, ax
   250 00000184 8EE0                     ;;;  mov fs, ax
   251                                          mov     ss, ax                  ; init stack segment
   251 00000186 8ED0                     ;;;  mov ss, ax
   252                                          mov     esp, [CodeSegmentStart]
   252 00000188 8B25[00000000]           ;;;  mov esp, [CodeSegmentStart]
   253                                  
   254                                          sub     esp, MCP_STACK_GAP          ; Safety margin
   254 0000018E 83EC10                   ;;;  sub esp, (16 + 0)
   255                                  
   256                                          mov     ebx, [CodeSegmentStart]
   256 00000191 8B1D[00000000]           ;;;  mov ebx, [CodeSegmentStart]
   257                                          sub     ebx, MCP_SHADOW_STACK_GAP  ; setting up shadow stack buffer
   257 00000197 83EB00                   ;;;  sub ebx, 0
   258                                          mov     DWORD [shadow_stack_vesp], ebx
   258 0000019A 891D[00000000]           ;;;  mov DWORD [shadow_stack_vesp], ebx
   259                                  
   260                                          STACK_TEST_FILL_IN
   260                              <1>  ;;; [macro] STACK_TEST_FILL_IN
   214                              <1> %if (MKF_ENGINEERING == 1)
   215                              <1>  mov edi, stackStart
   215 000001A0 BF[00000000]        <1>  ;;;  mov edi, stackStart
   216                              <1>  mov ecx, esp
   216 000001A5 89E1                <1>  ;;;  mov ecx, esp
   217                              <1>  sub ecx, stackStart
   217 000001A7 81E9[00000000]      <1>  ;;;  sub ecx, stackStart
   218                              <1>  shr ecx, 2
   218 000001AD C1E902              <1>  ;;;  shr ecx, 2
   219                              <1>  mov eax, 0CCCCCCCCh
   219 000001B0 B8CCCCCCCC          <1>  ;;;  mov eax, 0CCCCCCCCh
   220                              <1>  rep stosd
   220 000001B5 F3AB                <1>  ;;;  rep stosd
   221                              <1> %endif
   261                                  
   262                                  
   263                                          mov     [AcmBase], ebp            ; save Acm.base
   263 000001B7 892D[4C000000]           ;;;  mov [AcmBase], ebp
   264                                          mov     DWORD [AcmTop], ebp
   264 000001BD 892D[54000000]           ;;;  mov DWORD [AcmTop], ebp
   265                                          xor     edx, edx
   265 000001C3 31D2                     ;;;  xor edx, edx
   266                                          mov     eax, [HeaderStart+ACM_HEADER_0.Dummy_2_var + Dummy_2.Sizeb]
   266 000001C5 A1[18000000]             ;;;  mov eax, [HeaderStart+ACM_HEADER_0.Dummy_2_var + Dummy_2.Sizeb]
   267                                          shl     eax, 02h                ; mult by 4
   267 000001CA C1E002                   ;;;  shl eax, 02h
   268                                          mov     [AcmSize], eax            ; save ACM.Size in bytes
   268 000001CD A3[44000000]             ;;;  mov [AcmSize], eax
   269                                          add     [AcmTop], eax             ; Save end address of ACM
   269 000001D2 0105[54000000]           ;;;  add [AcmTop], eax
   270                                          
   271                                  ; HSW Sighting #3865022 Start
   272                                          ;
   273                                          ; The race condition between uCode issuing CMD.OPEN-PRIVATE
   274                                          ; and ACM reading crash register to save/restore it has been
   275                                          ; identified. The race condirion led to value "-1" read from
   276                                          ; status register because private space has not been actually
   277                                          ; opened yet at the time of this read. Measured delay between
   278                                          ; command and read was approximately 4us. Delay loop below is
   279                                          ; 5 times longer what has be sufficient in all casese unless
   280                                          ; part is hopelessy broken. Yet another side effect is
   281                                          ; that if the loop expires meaning that private space is not
   282                                          ; opened we cannot issue LT.RESET or update crash code since
   283                                          ; both registers belong to closed private space.
   284                                          ; That is why since there is no good action to take, we are
   285                                          ; not doing any and let code fall through. The same whould
   286                                          ; happen without added loop so code doesn't add any
   287                                          ; additional risk. The full analysis of what would
   288                                          ; happen if private space fails to open at all is left
   289                                          ; to SecoE.
   290                                          ; 
   291                                          ; 1308887577 fix:
   292                                          ; retry a long time, don't write to io ports
   293                                          RETRIES          EQU     080000000h
   293                                   ;;;  RETRIES EQU 080000000h
   294                                          
   295                                          mov     ecx, RETRIES
   295 000001D8 B900000080               ;;;  mov ecx, RETRIES
   296                                          mov     edi, LT_PRV_BASE + TXT.LT_STS
   296 000001DD BF0000D2FE               ;;;  mov edi, 0xFED20000 + TXT.LT_STS
   297                                          
   298                                          REPEAT
   298                              <1>  ;;; [macro] REPEAT
   825                              <1> 
   826                              <1>  %push REPEAT
   827                              <1>  %$begin:
   827                              <1>  ;;;  ..@114.begin:
   828                              <1> 
   299                                          mov         eax,dword [edi]
   299 000001E2 8B07                     ;;;  mov eax,dword [edi]
   300                                          BREAK_IF_NOTEQUAL eax,0FFFFFFFFh     ; Break the loop IF eax != 0FFFFFFFFh
   300                              <1>  ;;; [macro] BREAK_IF_NOTEQUAL {eax},{0FFFFFFFFh}
   873                              <1>  %ifctx REPEAT
   874                              <1>  cmp %1,%2
   874 000001E4 83F8FF              <1>  ;;;  cmp eax,0FFFFFFFFh
   875                              <1>  jne %$break
   875 000001E7 7504                <1>  ;;;  jne ..@114.break
   876                              <1>  %else
   877                              <1>  %fatal "BREAK_IF must be inside REPEAT"
   878                              <1>  %endif
   301                                            pause          
   301 000001E9 F390                     ;;;  pause
   302                                          UNTILCXZ
   302                              <1>  ;;; [macro] UNTILCXZ
   847                              <1> 
   848                              <1>  loop %$begin
   848 000001EB E2F5                <1>  ;;;  loop ..@114.begin
   849                              <1> %$break:
   849                              <1>  ;;; ..@114.break:
   850                              <1>  %pop
   851                              <1> 
   303                                          test ecx, ecx
   303 000001ED 85C9                     ;;;  test ecx, ecx
   304                                          jnz OPENED_PRIVATE_SPACE
   304 000001EF 7502                     ;;;  jnz OPENED_PRIVATE_SPACE
   305                                          ud2
   305 000001F1 0F0B                     ;;;  ud2
   306                                          OPENED_PRIVATE_SPACE:
   306                                   ;;;  OPENED_PRIVATE_SPACE:
   307                                          
   308                                  ; HSW Sighting #3865022 End 
   309                                     
   310                                          call  Update_CRx
   310 000001F3 E8(00000000)             ;;;  call Update_CRx
   311                                          
   312                                          jmp     commonAcmEntryPoint
   312 000001F8 E9(00000000)             ;;;  jmp commonAcmEntryPoint
   313                                  
